<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <title>FreshKeep</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🥬</text></svg>">
    <style>
        /* CSS Custom Properties for Theme Support */
        :root {
            /* Light Theme Colors - Material Design */
            --surface: #ffffff;
            --background: #fafafa;
            --surface-variant: #f5f5f5;
            --on-surface: #1c1b1f;
            --on-surface-variant: #49454f;
            --on-background: #1c1b1f;
            --primary: #0095f6;
            --primary-variant: #1877f2;
            --on-primary: #ffffff;
            --secondary: #625b71;
            --on-secondary: #ffffff;
            --outline: #79747e;
            --outline-variant: #cac4d0;
            --shadow: rgba(0, 0, 0, 0.12);
            --elevation-1: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --elevation-2: 0 2px 8px rgba(0, 0, 0, 0.08);
            --elevation-3: 0 4px 12px rgba(0, 0, 0, 0.15);

            /* Status Colors */
            --success-container: #e8f5e8;
            --on-success-container: #2e7d2e;
            --warning-container: #fff3cd;
            --on-warning-container: #856404;
            --error-container: #f8d7da;
            --on-error-container: #721c24;

            /* Location Colors */
            --pantry-container: #d4edda;
            --on-pantry-container: #155724;
            --fridge-container: #cce7ff;
            --on-fridge-container: #004085;
            --freezer-container: #d1ecf1;
            --on-freezer-container: #0c5460;
        }

        /* Dark Theme Colors - Material Design */
        [data-theme="dark"] {
            --surface: #1c1b1f;
            --background: #121212;
            --surface-variant: #2d2d2d;
            --on-surface: #e6e1e5;
            --on-surface-variant: #cac4d0;
            --on-background: #e6e1e5;
            --primary: #3d9dff;
            --primary-variant: #5da9ff;
            --on-primary: #000000;
            --secondary: #3f3f3f;
            --on-secondary: #ffffff;
            --outline: #ffffff;
            --outline-variant: #49454f;
            --shadow: rgba(0, 0, 0, 0.3);
            --elevation-1: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.4);
            --elevation-2: 0 2px 8px rgba(0, 0, 0, 0.25);
            --elevation-3: 0 4px 12px rgba(0, 0, 0, 0.35);

            /* Dark Status Colors */
            --success-container: #1b5e20;
            --on-success-container: #c8e6c9;
            --warning-container: #e65100;
            --on-warning-container: #fff3e0;
            --error-container: #c62828;
            --on-error-container: #ffebee;

            /* Dark Location Colors */
            --pantry-container: #2e7d32;
            --on-pantry-container: #c8e6c9;
            --fridge-container: #1565c0;
            --on-fridge-container: #e3f2fd;
            --freezer-container: #00838f;
            --on-freezer-container: #e0f2f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: var(--on-background);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 935px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .header {
            text-align: center;
            padding: 20px 0 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--outline-variant);
            margin-bottom: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--elevation-2);
            transition: all 0.3s ease;
        }

        .header-top {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 2.2em;
            font-family: 'Pacifico', cursive;
            font-weight: 400;
            letter-spacing: 0.5px;
            line-height: 1.1;
            color: var(--on-surface);
            text-shadow: none;
        }

        .theme-toggle {
            position: absolute;
            right: 0;
            background: var(--surface-variant);
            border: 1px solid var(--outline-variant);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--on-surface-variant);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: var(--on-primary);
            transform: scale(1.1);
        }

        .theme-icon {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .header p {
            font-size: 14px;
            color: var(--on-surface-variant);
            font-weight: 400;
            margin: 0;
            opacity: 1;
        }

        .add-form {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--outline-variant);
            transition: all 0.3s ease;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--on-surface);
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--outline-variant);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            background: var(--surface);
            color: var(--on-surface);
            font-family: 'Inter', inherit;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: 0 0 0 3px rgba(61, 157, 255, 0.2);
        }

        .form-group input::placeholder {
            color: var(--on-surface-variant);
            opacity: 0.7;
        }

        .search-box:focus, .sort-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(61, 157, 255, 0.2);
        }

        .connection-status {
            position: fixed;
            bottom: 16px;
            right: 16px;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 6px;
            background: var(--surface-variant);
            color: var(--on-surface-variant);
            border: 1px solid var(--outline-variant);
            box-shadow: var(--elevation-1);
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .connection-status:hover {
            opacity: 1;
            transform: translateY(-1px);
        }

        /* Authentication Modal - Mobile First */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            box-sizing: border-box;
        }

        .auth-modal-content {
            background: var(--surface);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--elevation-3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            padding: 24px 24px 16px;
            text-align: center;
            border-bottom: 1px solid var(--outline-variant);
        }

        .auth-header h2 {
            color: var(--on-surface);
            font-size: 24px;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: var(--on-surface-variant);
            font-size: 14px;
            line-height: 1.4;
        }

        .auth-form {
            padding: 24px;
        }

        /* Fix form inputs in modals */
        .auth-form input, .auth-form select, .auth-form textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--outline-variant);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--surface);
            color: var(--on-surface);
            font-family: 'Inter', inherit;
            box-sizing: border-box;
        }

        .auth-form input:focus, .auth-form select:focus, .auth-form textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(61, 157, 255, 0.2);
        }

        .auth-form input::placeholder, .auth-form textarea::placeholder {
            color: var(--on-surface-variant);
            opacity: 0.7;
        }

        .auth-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--on-surface);
            font-size: 14px;
        }

        /* Fix checkboxes in modals */
        .auth-form input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            accent-color: var(--primary);
        }

        /* Fix inline labels for checkboxes */
        .auth-form label[style*="flex"] {
            font-weight: normal;
            color: var(--on-surface);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--surface-variant);
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--on-surface-variant);
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .auth-tab.active {
            background: var(--primary);
            color: var(--on-primary);
        }

        .auth-submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: var(--on-primary);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 16px;
            touch-action: manipulation;
        }

        .auth-submit-btn:hover {
            background: var(--primary-variant);
            transform: translateY(-1px);
        }

        .auth-error {
            background: var(--error-container);
            color: var(--on-error-container);
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
        }

        .auth-footer {
            padding: 16px 24px 24px;
            text-align: center;
            border-top: 1px solid var(--outline-variant);
        }

        .auth-skip-btn {
            background: transparent;
            color: var(--on-surface-variant);
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .auth-skip-btn:hover {
            background: var(--surface-variant);
        }

        /* User Menu - Mobile First */
        .user-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 320px;
            height: 100%;
            background: var(--surface);
            z-index: 9999;
            transition: right 0.3s ease;
            box-shadow: var(--elevation-3);
            visibility: hidden;
        }

        .user-menu.show {
            right: 0;
            visibility: visible;
        }

        .user-menu-content {
            padding: 24px;
            height: 100%;
            overflow-y: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--outline-variant);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
        }

        .user-name {
            font-weight: 600;
            color: var(--on-surface);
            font-size: 16px;
        }

        .user-email {
            color: var(--on-surface-variant);
            font-size: 14px;
            margin-top: 2px;
        }

        .household-info {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--outline-variant);
        }

        .household-info h3 {
            color: var(--on-surface);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .user-action-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: var(--on-primary);
            border: 1px solid var(--primary);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 8px;
            text-align: left;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .user-action-btn:hover {
            background: var(--primary-variant);
            transform: translateY(-1px);
            box-shadow: var(--elevation-2);
        }

        .user-action-btn.danger {
            background: var(--error-container);
            color: var(--on-error-container);
            border-color: var(--error-container);
        }

        .user-action-btn.danger:hover {
            background: #d32f2f;
            color: #ffffff;
            transform: translateY(-1px);
        }

        /* User Profile Button in Header */
        .user-profile-btn {
            position: absolute;
            left: 0;
            background: var(--surface-variant);
            border: 2px solid var(--primary);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--on-surface-variant);
            font-size: 18px;
            z-index: 100;
        }

        .user-profile-btn:hover {
            background: var(--primary);
            color: var(--on-primary);
            transform: scale(1.1);
        }

        .user-profile-btn:active {
            transform: scale(0.95);
            background: var(--primary-variant);
        }

        /* Settings Modal - Mobile First */
        .settings-modal-container {
            padding: 8px;
        }
        .settings-modal-content {
            background: var(--surface);
            border-radius: 12px;
            width: 100%;
            height: calc(100vh - 16px);
            max-height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--elevation-3);
            animation: slideUp 0.3s ease;
        }
        .settings-modal-content .auth-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--outline-variant);
            flex-shrink: 0;
        }
        .settings-modal-content .auth-header h2 {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .settings-modal-content .auth-header p {
            font-size: 14px;
            margin: 0;
        }
        .settings-modal-content .settings-tabs {
            padding: 12px 16px 0;
            flex-shrink: 0;
            border-bottom: 1px solid var(--outline-variant);
        }
        .settings-modal-content .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            min-height: 0;
        }
        .settings-modal-content .auth-footer {
            padding: 12px 20px 16px;
            border-top: 1px solid var(--outline-variant);
            flex-shrink: 0;
        }

        /* Tablet and Desktop */
        @media (min-width: 768px) {
            .settings-modal-container {
                padding: 20px;
            }
            .settings-modal-content {
                max-width: 700px;
                height: 85vh;
                max-height: 85vh;
                margin: 0 auto;
                border-radius: 16px;
            }
            .settings-modal-content .auth-header {
                padding: 24px 32px 16px;
            }
            .settings-modal-content .auth-header h2 {
                font-size: 24px;
            }
            .settings-modal-content .auth-header p {
                font-size: 16px;
            }
            .settings-modal-content .settings-tabs {
                padding: 16px 24px 0;
            }
            .settings-modal-content .settings-content {
                padding: 20px 32px;
            }
            .settings-modal-content .auth-footer {
                padding: 16px 32px 24px;
            }
        }

        /* Household Settings Modal */
        .settings-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 16px 24px 0;
            border-bottom: 1px solid var(--outline-variant);
            overflow-x: auto;
        }

        .settings-tab {
            padding: 12px 16px;
            background: transparent;
            color: var(--on-surface-variant);
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            touch-action: manipulation;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .settings-tab.active {
            background: var(--primary);
            color: var(--on-primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        .settings-tab:hover:not(.active) {
            background: var(--surface-variant);
            color: var(--on-surface);
            border-color: var(--outline);
        }

        .settings-tab:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Accessible form controls for settings */
        .role-select, .member-actions select, .invitation-actions select, .guest-actions select {
            padding: 8px 12px;
            border: 1.5px solid var(--outline-variant);
            border-radius: 6px;
            background: var(--surface);
            color: var(--on-surface);
            font-size: 14px;
            min-height: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .role-select:focus, .member-actions select:focus, .invitation-actions select:focus, .guest-actions select:focus {
            outline: 2px solid var(--primary);
            outline-offset: 1px;
            border-color: var(--primary);
        }

        /* Fix manual barcode and other inline styled inputs */
        .manual-barcode-input {
            flex: 1;
            padding: 12px 16px;
            border: 1.5px solid var(--outline-variant);
            border-radius: 8px;
            font-size: 16px;
            background: var(--surface);
            color: var(--on-surface);
            transition: all 0.2s ease;
        }
        .manual-barcode-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 1px;
            border-color: var(--primary);
        }
        .manual-barcode-input::placeholder {
            color: var(--on-surface-variant);
            opacity: 0.7;
        }

        /* Fix search box and sort select theming */
        .search-box, .sort-select {
            background: var(--surface) !important;
            color: var(--on-surface) !important;
            border: 1.5px solid var(--outline-variant) !important;
        }
        .search-box:focus, .sort-select:focus {
            border-color: var(--primary) !important;
            outline: 2px solid var(--primary);
            outline-offset: 1px;
        }
        .search-box::placeholder {
            color: var(--on-surface-variant) !important;
            opacity: 0.7;
        }

        /* Fix category and location inputs */
        .category-input, .location-input {
            flex: 1;
            padding: 12px 16px;
            border: 1.5px solid var(--outline-variant);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface);
            color: var(--on-surface);
            transition: all 0.2s ease;
        }
        .category-input:focus, .location-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 1px;
            border-color: var(--primary);
        }
        .category-input::placeholder, .location-input::placeholder {
            color: var(--on-surface-variant);
            opacity: 0.7;
        }

        /* Fix checkbox styling for dark theme compatibility */
        input[type="checkbox"] {
            accent-color: var(--primary);
            background: var(--surface);
            border: 1.5px solid var(--outline-variant);
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }

        /* Comprehensive form control theming to override browser defaults */
        input, select, textarea {
            background: var(--surface) !important;
            color: var(--on-surface) !important;
            border: 1.5px solid var(--outline-variant) !important;
            border-radius: 8px !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary) !important;
            outline: 2px solid var(--primary) !important;
            outline-offset: 1px !important;
        }
        input::placeholder, textarea::placeholder {
            color: var(--on-surface-variant) !important;
            opacity: 0.7 !important;
        }

        /* Exception for checkboxes and radio buttons */
        input[type="checkbox"], input[type="radio"] {
            width: 18px !important;
            height: 18px !important;
            border-radius: 4px !important;
        }
        input[type="radio"] {
            border-radius: 50% !important;
        }

        /* Button classes for inline styled elements */
        .lookup-btn, .batch-add-all-btn, .batch-clear-btn, .stop-scanner-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            min-height: 40px;
            touch-action: manipulation;
        }

        .lookup-btn, .batch-add-all-btn {
            background: var(--primary);
            color: var(--on-primary);
        }
        .lookup-btn:hover, .batch-add-all-btn:hover {
            background: var(--primary-variant);
            transform: translateY(-1px);
        }

        .batch-clear-btn, .stop-scanner-btn {
            background: var(--error-container);
            color: var(--on-error-container);
        }
        .batch-clear-btn:hover, .stop-scanner-btn:hover {
            background: var(--error);
            color: var(--on-error);
        }

        /* Fix existing batch-remove button styling */
        .batch-remove {
            padding: 8px 12px;
            background: var(--error-container) !important;
            color: var(--on-error-container) !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer;
            font-size: 12px;
        }
        .batch-remove:hover {
            background: var(--error) !important;
            color: var(--on-error) !important;
        }

        .settings-content {
            padding: 16px 24px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel h3 {
            color: var(--on-surface);
            font-size: 18px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--outline-variant);
            padding-bottom: 8px;
        }

        .settings-panel h4 {
            color: var(--on-surface);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .settings-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 48px;
            min-width: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .settings-btn.primary {
            background: var(--primary);
            color: var(--on-primary);
        }

        .settings-btn.primary:hover {
            background: var(--primary-variant);
            transform: translateY(-1px);
        }

        .settings-btn.danger {
            background: var(--error-container);
            color: var(--on-error-container);
        }

        .settings-btn.danger:hover {
            background: #d32f2f;
            color: #ffffff;
            transform: translateY(-1px);
        }

        .member-card {
            background: var(--surface-variant);
            border: 1px solid var(--outline-variant);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: var(--on-surface);
            font-size: 14px;
        }

        .member-email {
            color: var(--on-surface-variant);
            font-size: 14px;
        }

        .member-role {
            background: var(--warning-container);
            color: var(--on-warning-container);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }

        .member-role.admin {
            background: var(--success-container);
            color: var(--on-success-container);
        }

        .duration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .duration-grid > div {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .duration-grid label {
            font-size: 14px;
            font-weight: 500;
            color: var(--on-surface-variant);
        }

        .duration-grid input {
            padding: 8px;
            border: 1px solid var(--outline-variant);
            border-radius: 6px;
            background: var(--surface);
            color: var(--on-surface);
            font-size: 14px;
        }

        .data-section {
            margin-bottom: 24px;
            padding: 16px;
            border: 1px solid var(--outline-variant);
            border-radius: 12px;
            background: var(--surface-variant);
        }

        .data-section h4 {
            margin-top: 0;
        }

        .data-section p {
            color: var(--on-surface-variant);
            font-size: 14px;
            margin: 8px 0;
        }

        .danger-zone {
            border-color: var(--error-container);
            background: var(--error-container);
        }

        .invitation-card, .guest-card {
            background: var(--surface-variant);
            border: 1px solid var(--outline-variant);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .invitation-email, .guest-name {
            font-weight: 500;
            color: var(--on-surface);
        }

        .invitation-status, .guest-expires {
            font-size: 14px;
            color: var(--on-surface-variant);
        }

        /* Responsive Design - Tablet and Desktop */
        @media (min-width: 768px) {
            .auth-modal-content {
                max-width: 480px;
            }

            .user-menu {
                max-width: 380px;
            }

            .auth-header {
                padding: 32px 32px 24px;
            }

            .auth-form {
                padding: 32px;
            }

            .auth-footer {
                padding: 24px 32px 32px;
            }

            .settings-tabs {
                flex-wrap: nowrap;
                gap: 8px;
                overflow-x: visible;
            }

            .settings-tab {
                font-size: 14px;
                padding: 10px 16px;
            }

            .duration-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .add-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: var(--on-primary);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            height: fit-content;
            min-height: 44px;
            touch-action: manipulation;
            font-family: 'Inter', inherit;
        }

        .add-btn:hover {
            background: var(--primary-variant);
            transform: translateY(-1px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin: 20px 0;
            padding: 0 20px;
        }

        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--outline-variant);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--elevation-3);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 800;
            color: var(--on-surface);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--on-surface-variant);
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            padding: 0 20px 40px;
        }

        .item-card {
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--outline-variant);
            transition: all 0.2s ease;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--elevation-3);
        }

        .item-header {
            padding: 16px 16px 12px;
        }

        .item-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--on-surface);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .item-category {
            background: var(--surface-variant);
            color: var(--on-surface-variant);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .item-details {
            padding: 0 16px;
            color: var(--on-surface-variant);
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .days-left {
            margin: 12px 16px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .fresh {
            background: var(--success-container);
            color: var(--on-success-container);
            border: 1px solid var(--on-success-container);
        }
        .warning {
            background: var(--warning-container);
            color: var(--on-warning-container);
            border: 1px solid var(--on-warning-container);
        }
        .expired {
            background: var(--error-container);
            color: var(--on-error-container);
            border: 1px solid var(--on-error-container);
        }

        .delete-btn {
            width: 100%;
            padding: 12px;
            background: var(--secondary);
            color: var(--on-secondary);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            touch-action: manipulation;
            font-family: 'Inter', inherit;
        }

        .delete-btn:hover {
            background: var(--outline);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: 0 0 0 3px rgba(61, 157, 255, 0.2);
        }

        .scan-btn:hover, .add-btn:hover {
            background: #1877f2;
            transform: translateY(-1px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
            padding: 0 16px;
            overflow-x: hidden;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px 12px;
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--outline-variant);
            transition: all 0.2s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 800;
            color: #262626;
            margin-bottom: 2px;
            line-height: 1;
        }

        .stat-label {
            color: #8e8e8e;
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 0 16px 60px;
        }

        .item-card {
            background: var(--surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--outline-variant);
            transition: all 0.2s ease;
        }

        .item-card:active {
            transform: scale(0.98);
        }

        .item-header {
            padding: 16px 16px 8px;
        }

        .item-name {
            font-size: 18px;
            font-weight: 700;
            color: #262626;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .delete-btn {
            width: 100%;
            padding: 16px;
            background: #262626;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 16px;
            touch-action: manipulation;
            font-family: 'Inter', inherit;
            min-height: 48px;
            -webkit-tap-highlight-color: transparent;
        }

        .delete-btn:active {
            background: #1a1a1a;
            transform: scale(0.98);
        }

        .storage-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            padding: 0 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--surface);
            border: 2px solid var(--outline-variant);
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', inherit;
            color: var(--on-surface);
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--on-primary);
            border-color: var(--primary);
        }

        .add-btn {
            padding: 16px 24px;
            background: #0095f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            height: fit-content;
            min-height: 48px;
            touch-action: manipulation;
            font-family: 'Inter', inherit;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #0095f6;
        }

        .add-btn:hover {
            background: #1877f2;
            border-color: #1877f2;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid #dbdbdb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            background: #fafafa;
            font-family: 'Inter', inherit;
            min-height: 48px;
            box-sizing: border-box;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: 0 0 0 3px rgba(61, 157, 255, 0.2);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
            padding: 0 16px;
            overflow-x: hidden;
        }

        .scan-btn:disabled {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%) !important;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        #scannerContainer {
            text-align: center;
            padding: 16px;
            background: var(--surface-variant);
            border-radius: 16px;
            margin: 8px 0;
        }

        .lookup-success {
            background: var(--success-container);
            color: var(--on-success-container);
            border: 1px solid var(--on-success-container);
            border-radius: 8px;
            padding: 12px;
        }

        .lookup-error {
            background: var(--error-container);
            color: var(--on-error-container);
            border: 1px solid var(--on-error-container);
            border-radius: 8px;
            padding: 12px;
        }

        .lookup-loading {
            background: var(--warning-container);
            color: var(--on-warning-container);
            border: 1px solid var(--on-warning-container);
            border-radius: 8px;
            padding: 12px;
        }

        .empty-state {
            text-align: center;
            color: var(--on-surface-variant);
            font-size: 16px;
            padding: 40px 20px;
            background: var(--surface);
            border-radius: 16px;
            margin: 16px;
            box-shadow: var(--elevation-2);
        }

        .storage-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 16px 0;
            padding: 0 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .storage-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 12px 18px;
            background: var(--surface);
            border: 2px solid var(--outline-variant);
            color: var(--on-surface);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', inherit;
            white-space: nowrap;
            min-width: fit-content;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-btn:active {
            transform: scale(0.95);
        }

        .search-sort-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 16px;
            align-items: stretch;
        }

        .search-box {
            padding: 16px;
            border: 2px solid var(--outline-variant);
            border-radius: 25px;
            font-size: 16px;
            font-family: 'Inter', inherit;
            background: var(--surface);
            color: var(--on-surface);
            transition: all 0.2s ease;
            min-height: 48px;
            box-sizing: border-box;
        }

        .search-box::placeholder {
            color: var(--on-surface-variant);
            opacity: 0.7;
        }

        .sort-select {
            padding: 16px;
            border: 2px solid var(--outline-variant);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', inherit;
            background: var(--surface);
            color: var(--on-surface);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
            box-sizing: border-box;
        }

        .clear-search {
            padding: 16px;
            background: var(--secondary);
            color: var(--on-secondary);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .clear-search:active {
            background: var(--outline);
            transform: scale(0.98);
        }

        .batch-remove {
            padding: 8px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            min-height: 36px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-btn:hover:not(.active) {
            background: #f8f9fa;
            border-color: #8e8e8e;
        }

        .tab-btn.pantry-tab.active {
            background: var(--success-container);
            border-color: var(--success-container);
            color: var(--on-success-container);
        }

        .tab-btn.fridge-tab.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }

        .tab-btn.freezer-tab.active {
            background: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .storage-location {
            margin: 8px 0 4px 0;
            font-size: 14px;
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 16px;
            display: inline-block;
        }

        .location-pantry {
            background: var(--pantry-container);
            color: var(--on-pantry-container);
            border: 1px solid var(--on-pantry-container);
        }

        .location-fridge {
            background: var(--fridge-container);
            color: var(--on-fridge-container);
            border: 1px solid var(--on-fridge-container);
        }

        .location-freezer {
            background: var(--freezer-container);
            color: var(--on-freezer-container);
            border: 1px solid var(--on-freezer-container);
        }

        .item-details {
            padding: 0 16px;
            color: var(--on-surface-variant);
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .days-left {
            margin: 12px 16px;
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .fresh {
            background: var(--success-container);
            color: var(--on-success-container);
            border: 1px solid var(--on-success-container);
        }
        .warning {
            background: var(--warning-container);
            color: var(--on-warning-container);
            border: 1px solid var(--on-warning-container);
        }
        .expired {
            background: var(--error-container);
            color: var(--on-error-container);
            border: 1px solid var(--on-error-container);
        }

        .batch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--surface);
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--outline-variant);
            color: var(--on-surface);
        }

        .batch-item-info {
            flex: 1;
        }

        .batch-item-name {
            font-weight: 600;
            color: #262626;
            font-size: 14px;
        }

        .batch-item-details {
            color: #8e8e8e;
            font-size: 12px;
            margin-top: 2px;
        }

        .batch-remove {
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }

        @media (min-width: 769px) {
            .stats {
                grid-template-columns: repeat(5, 1fr);
                gap: 16px;
                margin: 20px 0;
                padding: 0 20px;
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 16px;
                padding: 0 20px 40px;
            }

            .container {
                padding: 0 20px;
            }

            .search-sort-container {
                flex-direction: row;
                gap: 15px;
                margin: 20px;
                align-items: center;
            }

            .search-box {
                flex: 1;
                min-width: 200px;
            }

            .primary-scan:hover {
                background: #1877f2;
                border-color: #1877f2;
            }

            .secondary-scan:hover {
                background: #e8690b;
                border-color: #e8690b;
            }

            .tertiary-scan:hover {
                background: #5a3499;
                border-color: #5a3499;
            }

            .scan-tab:hover:not(:disabled) {
                transform: scale(1.02);
            }

            .tab-btn:hover:not(.active) {
                background: #f8f9fa;
                border-color: #8e8e8e;
            }

            .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            .item-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }

            .clear-search:hover {
                background: #5a6268;
            }

            .scan-btn:hover, .add-btn:hover {
                transform: translateY(-1px);
            }

            .delete-btn:hover {
                background: #1a1a1a;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <button class="user-profile-btn" onclick="toggleUserMenu()" id="userProfileBtn" aria-label="User profile" style="display: none;">
                    <span id="userProfileIcon">👤</span>
                </button>
                <h1>🥬 FreshKeep</h1>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
                    <span class="theme-icon">🌙</span>
                </button>
            </div>
            <p>Track everything in your pantry, fridge, and freezer - never waste food again!</p>
        </div>

        <div class="add-form">
            <div class="scan-section" style="margin-bottom: 20px;">
                <div class="scan-buttons" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                    <button class="tab-btn scan-tab primary-scan" id="scanBtn" onclick="toggleScanner()">
                        📱 Scan Barcode
                    </button>
                    <button class="tab-btn scan-tab secondary-scan" id="batchBtn" onclick="toggleBatchMode()">
                        📦 Batch Scan
                    </button>
                    <button class="tab-btn scan-tab tertiary-scan" onclick="toggleManualEntry()">
                        ⌨️ Manual Entry
                    </button>
                </div>
                
                <div id="manualEntry" style="display: none; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="manualBarcode" placeholder="Enter barcode number..." class="manual-barcode-input">
                        <button onclick="lookupManualBarcode()" class="lookup-btn">Lookup</button>
                    </div>
                </div>

                <div id="batchQueue" style="display: none; margin-bottom: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px dashed #dee2e6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>Batch Mode - Items in Queue: <span id="batchCount">0</span></strong>
                            <div>
                                <button onclick="addAllBatchItems()" class="batch-add-all-btn">Add All</button>
                                <button onclick="clearBatchQueue()" class="batch-clear-btn">Clear Queue</button>
                            </div>
                        </div>
                        <div id="batchItems" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>

                <div id="scannerContainer" style="display: none; margin-top: 15px;">
                    <div style="position: relative; display: inline-block;">
                        <video id="video" autoplay muted playsinline style="width: 100%; max-width: 400px; border-radius: 8px; display: block;"></video>
                        <canvas id="canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid #ff0000; width: 200px; height: 100px; border-radius: 8px; pointer-events: none; box-shadow: 0 0 0 9999px rgba(0,0,0,0.3);"></div>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <button onclick="stopScanner()" class="stop-scanner-btn">Stop Scanning</button>
                        <span id="scanMode" style="margin-left: 15px; font-weight: 500;"></span>
                    </div>
                </div>
                <div id="lookupStatus" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="itemName">Item Name</label>
                    <input type="text" id="itemName" placeholder="e.g., Ground beef, Rice, Milk... or scan barcode above" required>
                </div>
                <div class="form-group">
                    <label for="storageLocation">Storage Location</label>
                    <select id="storageLocation" onchange="toggleDateField()">
                        <option value="Pantry">🏠 Pantry</option>
                        <option value="Fridge">❄️ Fridge</option>
                        <option value="Freezer">🧊 Freezer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category">
                        <option value="Meat">Meat</option>
                        <option value="Vegetables">Vegetables</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Grains">Grains</option>
                        <option value="Canned">Canned Goods</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Condiments">Condiments</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Desserts">Desserts</option>
                        <option value="Prepared">Prepared Foods</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group" id="dateGroup">
                    <label for="storedDate" id="dateLabel">Date Added</label>
                    <input type="date" id="storedDate" required>
                </div>
                <button class="add-btn" onclick="addItem()">Add Item</button>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">0</div>
                <div class="stat-label">Total Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pantryItems">0</div>
                <div class="stat-label">Pantry</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="fridgeItems">0</div>
                <div class="stat-label">Fridge</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="freezerItems">0</div>
                <div class="stat-label">Freezer</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expiringSoon">0</div>
                <div class="stat-label">Use Soon</div>
            </div>
        </div>

        <div class="storage-tabs">
            <button class="tab-btn active" onclick="switchTab('all')" id="allTab">All Items</button>
            <button class="tab-btn pantry-tab" onclick="switchTab('pantry')" id="pantryTab">🏠 Pantry</button>
            <button class="tab-btn fridge-tab" onclick="switchTab('fridge')" id="fridgeTab">❄️ Fridge</button>
            <button class="tab-btn freezer-tab" onclick="switchTab('freezer')" id="freezerTab">🧊 Freezer</button>
        </div>

        <div class="search-sort-container">
            <input type="text" class="search-box" id="searchBox" placeholder="🔍 Search items by name..." onkeyup="handleSearch()">
            <select class="sort-select" id="sortSelect" onchange="handleSort()">
                <option value="expiration">Sort by Expiration</option>
                <option value="name">Sort by Name</option>
                <option value="date-added">Sort by Date Added</option>
                <option value="location">Sort by Location</option>
                <option value="category">Sort by Category</option>
            </select>
            <button class="clear-search" onclick="clearSearch()">Clear</button>
        </div>

        <div class="items-grid" id="itemsGrid">
            <div class="empty-state">
                Your storage is empty! Add some items to get started.
            </div>
        </div>

        <!-- Firebase connection status -->
        <div id="connectionStatus" class="connection-status">
            Connecting to database...
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal" style="display: none;">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h2 id="authTitle">Welcome to FreshKeep</h2>
                <p id="authSubtitle">Sign in to sync your food inventory across all devices</p>
            </div>

            <form id="authForm" class="auth-form">
                <div class="auth-tabs">
                    <button type="button" class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
                    <button type="button" class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
                </div>

                <div class="form-group">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" required>
                </div>

                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" required>
                </div>

                <div id="signupFields" style="display: none;">
                    <div class="form-group">
                        <label for="authConfirmPassword">Confirm Password</label>
                        <input type="password" id="authConfirmPassword">
                    </div>
                    <div class="form-group">
                        <label for="authDisplayName">Display Name</label>
                        <input type="text" id="authDisplayName" placeholder="Your name">
                    </div>
                </div>

                <button type="submit" class="auth-submit-btn" id="authSubmitBtn">Sign In</button>

                <div class="auth-error" id="authError" style="display: none;"></div>
            </form>

            <div class="auth-footer">
                <button class="auth-skip-btn" onclick="skipAuth()">Continue without account</button>
            </div>
        </div>
    </div>

    <!-- User Profile Menu -->
    <div id="userMenu" class="user-menu">
        <div class="user-menu-content">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">👤</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-email" id="userEmail">Loading...</div>
                </div>
            </div>

            <div class="household-info">
                <h3>Household</h3>
                <div id="householdName">Loading...</div>
                <div class="household-members" id="householdMembers"></div>
            </div>

            <div class="user-actions">
                <button class="user-action-btn" onclick="showInviteModal()">👥 Invite Family</button>
                <button class="user-action-btn" onclick="showGuestShareModal()">🔗 Share with Guest</button>
                <button class="user-action-btn" onclick="showHouseholdSettings()">⚙️ Household Settings</button>
                <button class="user-action-btn danger" onclick="signOutUser()">🚪 Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Family Invitation Modal -->
    <div id="inviteModal" class="auth-modal" style="display: none;">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h2>Invite Family Member</h2>
                <p>Send an invitation to join your household</p>
            </div>

            <form id="inviteForm" class="auth-form">
                <div class="form-group">
                    <label for="inviteEmail">Email Address</label>
                    <input type="email" id="inviteEmail" placeholder="family@example.com" required>
                </div>

                <div class="form-group">
                    <label for="inviteMessage">Personal Message (Optional)</label>
                    <textarea id="inviteMessage"
                              placeholder="Join our family's FreshKeep household to share our food inventory!"
                              style="width: 100%; padding: 12px; border: 1.5px solid var(--outline-variant); border-radius: 8px; font-family: inherit; resize: vertical; min-height: 80px; background: var(--surface); color: var(--on-surface);"></textarea>
                </div>

                <button type="submit" class="auth-submit-btn">Send Invitation</button>

                <div class="auth-error" id="inviteError" style="display: none;"></div>
            </form>

            <div class="auth-footer">
                <button class="auth-skip-btn" onclick="closeInviteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Guest Share Modal -->
    <div id="guestShareModal" class="auth-modal" style="display: none;">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h2>Share with Guest</h2>
                <p>Create a temporary view-only link for babysitters, friends, or helpers</p>
            </div>

            <form id="guestShareForm" class="auth-form">
                <div class="form-group">
                    <label for="guestName">Guest Name (Optional)</label>
                    <input type="text" id="guestName" placeholder="e.g., Sarah the Babysitter">
                </div>

                <div class="form-group">
                    <label for="guestDuration">Access Duration</label>
                    <select id="guestDuration">
                        <option value="1">1 hour</option>
                        <option value="4">4 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                        <option value="168">1 week</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Permissions</label>
                    <div style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; margin-bottom: 8px; font-weight: normal;">
                            <input type="checkbox" id="guestCanViewExpiry" checked style="margin-right: 8px;">
                            View expiration dates
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; font-weight: normal;">
                            <input type="checkbox" id="guestCanViewLocation" checked style="margin-right: 8px;">
                            View storage locations
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" id="guestCanViewDetails" style="margin-right: 8px;">
                            View who added items
                        </label>
                    </div>
                </div>

                <button type="submit" class="auth-submit-btn">Create Guest Link</button>

                <div id="guestLinkResult" style="display: none; margin-top: 16px;">
                    <div style="background: var(--success-container); color: var(--on-success-container); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <strong>Guest link created!</strong>
                    </div>
                    <div style="background: var(--surface-variant); color: var(--on-surface); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all; border: 1px solid var(--outline-variant);" id="guestLinkUrl"></div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button type="button" onclick="copyGuestLink()" style="flex: 1; padding: 8px; background: var(--primary); color: var(--on-primary); border: none; border-radius: 6px; cursor: pointer;">Copy Link</button>
                        <button type="button" onclick="revokeGuestLink()" style="padding: 8px 12px; background: var(--error-container); color: var(--on-error-container); border: none; border-radius: 6px; cursor: pointer;">Revoke</button>
                    </div>
                </div>

                <div class="auth-error" id="guestShareError" style="display: none;"></div>
            </form>

            <div class="auth-footer">
                <button class="auth-skip-btn" onclick="closeGuestShareModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Household Settings Modal -->
    <div id="householdSettingsModal" class="auth-modal settings-modal-container" style="display: none;">
        <div class="settings-modal-content">
            <div class="auth-header">
                <h2>Household Settings</h2>
                <p>Manage your household members, settings, and preferences</p>
            </div>

            <div class="settings-tabs">
                <button class="settings-tab active" onclick="switchSettingsTab('members')">👥 Members</button>
                <button class="settings-tab" onclick="switchSettingsTab('household')">🏠 Household</button>
                <button class="settings-tab" onclick="switchSettingsTab('invitations')">📧 Invitations</button>
                <button class="settings-tab" onclick="switchSettingsTab('guests')">👁️ Guest Access</button>
                <button class="settings-tab" onclick="switchSettingsTab('data')">📊 Data</button>
                <button class="settings-tab" onclick="switchSettingsTab('advanced')">⚙️ Advanced</button>
            </div>

            <div class="settings-content">
                <!-- Members Tab -->
                <div id="settingsMembers" class="settings-panel active">
                    <h3>Household Members</h3>
                    <div id="membersList"></div>

                    <div class="member-actions" style="margin-top: 20px;">
                        <button class="settings-btn primary" onclick="showInviteModal()">
                            👥 Invite New Member
                        </button>
                    </div>
                </div>

                <!-- Household Tab -->
                <div id="settingsHousehold" class="settings-panel">
                    <h3>Household Information</h3>
                    <div class="auth-form">
                        <div class="form-group">
                            <label for="householdNameEdit">Household Name</label>
                            <input type="text" id="householdNameEdit" placeholder="Enter household name">
                        </div>

                        <div class="form-group">
                            <label for="householdTimezone">Timezone</label>
                            <select id="householdTimezone">
                                <option value="America/New_York">Eastern Time</option>
                                <option value="America/Chicago">Central Time</option>
                                <option value="America/Denver">Mountain Time</option>
                                <option value="America/Los_Angeles">Pacific Time</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Default Storage Durations (days)</label>
                            <div class="duration-grid">
                                <div><label>Fruits:</label><input type="number" id="durationFruits" value="7" min="1"></div>
                                <div><label>Vegetables:</label><input type="number" id="durationVegetables" value="7" min="1"></div>
                                <div><label>Dairy:</label><input type="number" id="durationDairy" value="10" min="1"></div>
                                <div><label>Meat:</label><input type="number" id="durationMeat" value="5" min="1"></div>
                                <div><label>Leftovers:</label><input type="number" id="durationLeftovers" value="3" min="1"></div>
                                <div><label>Other:</label><input type="number" id="durationOther" value="14" min="1"></div>
                            </div>
                        </div>

                        <button class="settings-btn primary" onclick="saveHouseholdSettings()">Save Changes</button>
                    </div>
                </div>

                <!-- Invitations Tab -->
                <div id="settingsInvitations" class="settings-panel">
                    <h3>Pending Invitations</h3>
                    <div id="pendingInvitationsList"></div>

                    <h3 style="margin-top: 30px;">Invitation Settings</h3>
                    <div class="auth-form">
                        <div class="form-group">
                            <label for="inviteExpiration">Default Invitation Expiration</label>
                            <select id="inviteExpiration">
                                <option value="24">24 hours</option>
                                <option value="168" selected>1 week</option>
                                <option value="336">2 weeks</option>
                                <option value="720">1 month</option>
                            </select>
                        </div>
                        <button class="settings-btn primary" onclick="saveInvitationSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- Guest Access Tab -->
                <div id="settingsGuests" class="settings-panel">
                    <h3>Active Guest Tokens</h3>
                    <div id="activeGuestsList"></div>

                    <div class="guest-actions" style="margin-top: 20px;">
                        <button class="settings-btn danger" onclick="revokeAllGuestTokens()">
                            🚫 Revoke All Guest Access
                        </button>
                        <button class="settings-btn primary" onclick="showGuestShareModal()">
                            🔗 Create New Guest Link
                        </button>
                    </div>

                    <h3 style="margin-top: 30px;">Default Guest Permissions</h3>
                    <div class="auth-form">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; font-weight: normal;">
                                <input type="checkbox" id="defaultGuestExpiry" checked style="margin-right: 8px;">
                                Allow guests to view expiration dates by default
                            </label>
                            <label style="display: flex; align-items: center; font-weight: normal;">
                                <input type="checkbox" id="defaultGuestLocation" checked style="margin-right: 8px;">
                                Allow guests to view storage locations by default
                            </label>
                            <label style="display: flex; align-items: center; font-weight: normal;">
                                <input type="checkbox" id="defaultGuestDetails" style="margin-right: 8px;">
                                Allow guests to view who added items by default
                            </label>
                        </div>
                        <button class="settings-btn primary" onclick="saveGuestSettings()">Save Defaults</button>
                    </div>
                </div>

                <!-- Data Tab -->
                <div id="settingsData" class="settings-panel">
                    <h3>Data Management</h3>

                    <div class="data-section">
                        <h4>Export Data</h4>
                        <p>Download your household data for backup or analysis</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="settings-btn primary" onclick="exportData('csv')">📊 Export as CSV</button>
                            <button class="settings-btn primary" onclick="exportData('json')">💾 Export as JSON</button>
                        </div>
                    </div>

                    <div class="data-section">
                        <h4>Data Retention</h4>
                        <div class="auth-form">
                            <div class="form-group">
                                <label for="autoDeleteDays">Auto-delete consumed items after (days)</label>
                                <select id="autoDeleteDays">
                                    <option value="0">Never</option>
                                    <option value="30">30 days</option>
                                    <option value="90" selected>90 days</option>
                                    <option value="365">1 year</option>
                                </select>
                            </div>
                            <button class="settings-btn primary" onclick="saveDataSettings()">Save Settings</button>
                        </div>
                    </div>

                    <div class="data-section">
                        <h4>Privacy Controls</h4>
                        <div class="auth-form">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; font-weight: normal;">
                                    <input type="checkbox" id="shareUsageStats" style="margin-right: 8px;">
                                    Share anonymous usage statistics to improve FreshKeep
                                </label>
                                <label style="display: flex; align-items: center; font-weight: normal;">
                                    <input type="checkbox" id="allowAnalytics" style="margin-right: 8px;">
                                    Allow analytics for app performance monitoring
                                </label>
                            </div>
                            <button class="settings-btn primary" onclick="savePrivacySettings()">Save Privacy Settings</button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div id="settingsAdvanced" class="settings-panel">
                    <h3>Advanced Settings</h3>

                    <div class="data-section">
                        <h4>Custom Categories</h4>
                        <div id="customCategoriesList"></div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="text" id="newCategoryName" placeholder="Category name" class="category-input">
                            <button class="settings-btn primary" onclick="addCustomCategory()">Add Category</button>
                        </div>
                    </div>

                    <div class="data-section">
                        <h4>Storage Locations</h4>
                        <div id="customLocationsList"></div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="text" id="newLocationName" placeholder="Location name" class="location-input">
                            <button class="settings-btn primary" onclick="addCustomLocation()">Add Location</button>
                        </div>
                    </div>

                    <div class="data-section">
                        <h4>Sync Settings</h4>
                        <div class="auth-form">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; font-weight: normal;">
                                    <input type="checkbox" id="enableOfflineMode" checked style="margin-right: 8px;">
                                    Enable offline mode with local storage fallback
                                </label>
                                <label style="display: flex; align-items: center; font-weight: normal;">
                                    <input type="checkbox" id="realTimeSync" checked style="margin-right: 8px;">
                                    Enable real-time synchronization across devices
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="data-section danger-zone">
                        <h4 style="color: var(--on-error-container);">⚠️ Danger Zone</h4>
                        <p>These actions cannot be undone</p>
                        <button class="settings-btn danger" onclick="confirmDeleteHousehold()">
                            🗑️ Delete Entire Household
                        </button>
                    </div>
                </div>
            </div>

            <div class="auth-footer">
                <button class="auth-skip-btn" onclick="closeHouseholdSettings()">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';

        // Firebase configuration - Replace with your actual config
        // To get your config:
        // 1. Go to https://console.firebase.google.com
        // 2. Create a new project or select existing one
        // 3. Add a web app to your project
        // 4. Enable Firestore Database in your project
        // 5. Copy the config object from Firebase console
        // 6. Set up Firestore Security Rules in Firebase Console > Firestore > Rules
        const firebaseConfig = {
            apiKey: "AIzaSyDlhIJzu9Ln_R2fAAgakKfFzzJgTDzautE",
            authDomain: "freshkeep-34a12.firebaseapp.com",
            projectId: "freshkeep-34a12",
            storageBucket: "freshkeep-34a12.firebasestorage.app",
            messagingSenderId: "332100833248",
            appId: "1:332100833248:web:e920634dc1485dfdcda585",
            measurementId: "G-WBKNQGT7JJ"
        };

        // Initialize Firebase
        try {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            window.firestoreUtils = { collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc, updateDoc };
            window.authUtils = { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile };
            console.log('Firebase initialized successfully');
            updateConnectionStatus('firebase');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            // Fallback to local storage if Firebase fails
            window.db = null;
            window.auth = null;
            updateConnectionStatus('local');
        }

        // Update connection status indicator
        function updateConnectionStatus(type) {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;

            if (type === 'firebase') {
                statusEl.textContent = '☁️ Connected to Firebase';
                statusEl.style.background = 'var(--success-container)';
                statusEl.style.color = 'var(--on-success-container)';
                statusEl.style.borderColor = 'var(--on-success-container)';
            } else if (type === 'guest') {
                statusEl.textContent = '🔗 Guest Mode';
                statusEl.style.background = 'var(--primary)';
                statusEl.style.color = 'var(--on-primary)';
                statusEl.style.borderColor = 'var(--primary)';
            } else {
                statusEl.textContent = '💾 Using Local Storage';
                statusEl.style.background = 'var(--warning-container)';
                statusEl.style.color = 'var(--on-warning-container)';
                statusEl.style.borderColor = 'var(--on-warning-container)';
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        let foodItems = [];
        let isScanning = false;
        let isBatchMode = false;
        let batchQueue = [];
        let currentTab = 'all';
        let searchTerm = '';
        let sortBy = 'expiration';

        // User and household management
        let currentUser = null;
        let currentHousehold = null;
        let isAuthenticated = false;
        let authMode = 'signin'; // 'signin' or 'signup'

        // Authentication Functions
        function initializeAuth() {
            if (!window.auth) return;

            // Listen for auth state changes
            window.authUtils.onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    currentUser = user;
                    isAuthenticated = true;
                    await handleUserSignedIn(user);
                } else {
                    currentUser = null;
                    isAuthenticated = false;
                    handleUserSignedOut();
                }
            });
        }

        async function handleUserSignedIn(user) {
            console.log('User signed in:', user.email);

            // Hide auth modal
            document.getElementById('authModal').style.display = 'none';

            // Show user profile button immediately and make it prominent
            const userProfileBtn = document.getElementById('userProfileBtn');
            if (userProfileBtn) {
                userProfileBtn.style.display = 'flex';
                userProfileBtn.style.border = '2px solid var(--primary)';
                console.log('User profile button shown');
            } else {
                console.error('User profile button not found');
            }

            // Check for pending invitation
            const pendingInvite = localStorage.getItem('pendingInvite');
            if (pendingInvite) {
                localStorage.removeItem('pendingInvite');
                try {
                    const inviteRef = window.firestoreUtils.doc(window.db, 'invitations', pendingInvite);
                    const inviteDoc = await window.firestoreUtils.getDoc(inviteRef);
                    if (inviteDoc.exists()) {
                        await acceptInvitation(pendingInvite, inviteDoc.data());
                        return; // acceptInvitation handles loading household
                    }
                } catch (error) {
                    console.error('Error processing pending invitation:', error);
                }
            }

            // Load or create household
            await loadUserHousehold(user);

            // Load food items for the household
            await loadHouseholdFoodItems();

            // Update UI
            updateUserUI();
        }

        function handleUserSignedOut() {
            console.log('User signed out');

            // Hide user profile button
            document.getElementById('userProfileBtn').style.display = 'none';

            // Clear data
            currentHousehold = null;
            foodItems = [];

            // Update display
            updateDisplay();
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            // Focus first input for accessibility
            setTimeout(() => {
                document.getElementById('authEmail').focus();
            }, 300);
        }

        function skipAuth() {
            document.getElementById('authModal').style.display = 'none';
            // Load from localStorage as fallback
            loadLocalStorageItems();
        }

        async function loadLocalStorageItems() {
            try {
                foodItems = await FirestoreService.loadFromLocalStorage();
                updateDisplay();
            } catch (error) {
                console.error('Error loading local storage:', error);
            }
        }

        function switchAuthTab(mode) {
            authMode = mode;
            const signupFields = document.getElementById('signupFields');
            const submitBtn = document.getElementById('authSubmitBtn');
            const tabs = document.querySelectorAll('.auth-tab');

            // Update tabs
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            if (mode === 'signup') {
                signupFields.style.display = 'block';
                submitBtn.textContent = 'Create Account';
            } else {
                signupFields.style.display = 'none';
                submitBtn.textContent = 'Sign In';
            }

            // Clear error
            hideAuthError();
        }

        // Handle auth form submission
        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', handleAuthSubmit);
            }
        });

        async function handleAuthSubmit(e) {
            e.preventDefault();

            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            if (authMode === 'signup') {
                const confirmPassword = document.getElementById('authConfirmPassword').value;
                const displayName = document.getElementById('authDisplayName').value;

                if (password !== confirmPassword) {
                    showAuthError('Passwords do not match');
                    return;
                }

                await signUpUser(email, password, displayName);
            } else {
                await signInUser(email, password);
            }
        }

        async function signInUser(email, password) {
            if (!window.auth) {
                showAuthError('Authentication not available');
                return;
            }

            try {
                await window.authUtils.signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                console.error('Sign in error:', error);
                showAuthError(getAuthErrorMessage(error.code));
            }
        }

        async function signUpUser(email, password, displayName) {
            if (!window.auth) {
                showAuthError('Authentication not available');
                return;
            }

            try {
                const userCredential = await window.authUtils.createUserWithEmailAndPassword(window.auth, email, password);

                // Update display name
                if (displayName) {
                    await window.authUtils.updateProfile(userCredential.user, {
                        displayName: displayName
                    });
                }

            } catch (error) {
                console.error('Sign up error:', error);
                showAuthError(getAuthErrorMessage(error.code));
            }
        }

        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'An account with this email already exists',
                'auth/weak-password': 'Password should be at least 6 characters',
                'auth/invalid-email': 'Please enter a valid email address',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later'
            };

            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideAuthError() {
            document.getElementById('authError').style.display = 'none';
        }

        // User Menu Functions
        function toggleUserMenu() {
            console.log('toggleUserMenu called'); // Debug log
            const userMenu = document.getElementById('userMenu');
            const userProfileBtn = document.getElementById('userProfileBtn');

            if (!userMenu) {
                console.error('User menu not found');
                return;
            }

            if (userMenu.classList.contains('show')) {
                userMenu.classList.remove('show');
                console.log('User menu hidden');
            } else {
                userMenu.classList.add('show');
                console.log('User menu shown');
            }
        }

        // Close user menu when clicking outside (mobile-friendly)
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('userMenu');
            const userProfileBtn = document.getElementById('userProfileBtn');

            if (userMenu && userProfileBtn &&
                !userMenu.contains(e.target) &&
                !userProfileBtn.contains(e.target)) {
                userMenu.classList.remove('show');
            }
        });

        async function signOutUser() {
            if (!window.auth) return;

            try {
                await window.authUtils.signOut(window.auth);
                // Close user menu
                document.getElementById('userMenu').classList.remove('show');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Household Management Functions
        async function loadUserHousehold(user) {
            if (!window.db) return;

            try {
                // First, check if user already belongs to a household
                const userDocRef = window.firestoreUtils.doc(window.db, 'users', user.uid);
                const userDoc = await window.firestoreUtils.getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.householdId) {
                        // Load existing household
                        await loadHousehold(userData.householdId);
                        return;
                    }
                }

                // Create new household for new user
                await createNewHousehold(user);

            } catch (error) {
                console.error('Error loading user household:', error);
            }
        }

        async function createNewHousehold(user) {
            if (!window.db) return;

            try {
                const householdName = `${user.displayName || user.email.split('@')[0]}'s Household`;

                // Create household document
                const householdRef = window.firestoreUtils.collection(window.db, 'households');
                const householdDoc = await window.firestoreUtils.addDoc(householdRef, {
                    name: householdName,
                    createdBy: user.uid,
                    createdAt: new Date(),
                    members: {
                        [user.uid]: {
                            role: 'admin',
                            joinedAt: new Date(),
                            displayName: user.displayName || user.email.split('@')[0],
                            email: user.email
                        }
                    }
                });

                // Update user document with household ID
                const userDocRef = window.firestoreUtils.doc(window.db, 'users', user.uid);
                await window.firestoreUtils.setDoc(userDocRef, {
                    householdId: householdDoc.id,
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    lastActive: new Date()
                }, { merge: true });

                // Set current household
                currentHousehold = {
                    id: householdDoc.id,
                    name: householdName,
                    createdBy: user.uid,
                    members: {
                        [user.uid]: {
                            role: 'admin',
                            joinedAt: new Date(),
                            displayName: user.displayName || user.email.split('@')[0],
                            email: user.email
                        }
                    }
                };

                console.log('Created new household:', householdDoc.id);

            } catch (error) {
                console.error('Error creating household:', error);
            }
        }

        async function loadHousehold(householdId) {
            if (!window.db) return;

            try {
                const householdRef = window.firestoreUtils.doc(window.db, 'households', householdId);
                const householdDoc = await window.firestoreUtils.getDoc(householdRef);

                if (householdDoc.exists()) {
                    currentHousehold = {
                        id: householdDoc.id,
                        ...householdDoc.data()
                    };

                    // Setup real-time listener for household changes
                    window.firestoreUtils.onSnapshot(householdRef, (doc) => {
                        if (doc.exists()) {
                            currentHousehold = {
                                id: doc.id,
                                ...doc.data()
                            };
                            updateUserUI();
                        }
                    });

                    console.log('Loaded household:', currentHousehold.name);
                } else {
                    console.error('Household not found');
                }

            } catch (error) {
                console.error('Error loading household:', error);
            }
        }

        async function loadHouseholdFoodItems() {
            if (!window.db || !currentHousehold) {
                // Fallback to local storage
                await loadLocalStorageItems();
                return;
            }

            try {
                // Query food items for this household
                const foodItemsRef = window.firestoreUtils.collection(window.db, 'foodItems');
                const q = window.firestoreUtils.query(
                    foodItemsRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id)
                );

                // Setup real-time listener for food items
                window.firestoreUnsubscribe = window.firestoreUtils.onSnapshot(q, (snapshot) => {
                    const items = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const item = {
                            ...data,
                            firestoreId: doc.id,
                            storedDate: new Date(data.storedDate),
                            addedDate: new Date(data.addedDate)
                        };
                        items.push(item);
                    });

                    foodItems = items;
                    updateDisplay();
                    console.log('Loaded household food items:', items.length);
                });

            } catch (error) {
                console.error('Error loading household food items:', error);
                await loadLocalStorageItems();
            }
        }

        function updateUserUI() {
            if (!currentUser || !currentHousehold) return;

            // Update user profile info
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            const householdName = document.getElementById('householdName');
            const householdMembers = document.getElementById('householdMembers');

            if (userName) userName.textContent = currentUser.displayName || currentUser.email.split('@')[0];
            if (userEmail) userEmail.textContent = currentUser.email;
            if (householdName) householdName.textContent = currentHousehold.name;

            // Update household members
            if (householdMembers && currentHousehold.members) {
                const memberCount = Object.keys(currentHousehold.members).length;
                householdMembers.innerHTML = `
                    <div style="color: var(--on-surface-variant); font-size: 14px; margin-top: 4px;">
                        ${memberCount} member${memberCount !== 1 ? 's' : ''}
                    </div>
                    <div style="margin-top: 8px;">
                        ${Object.values(currentHousehold.members).map(member => `
                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--primary); color: var(--on-primary); display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 8px;">
                                    ${member.displayName.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; color: var(--on-surface);">${member.displayName}</div>
                                    <div style="font-size: 12px; color: var(--on-surface-variant);">${member.role}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Family Invitation System
        function showInviteModal() {
            if (!currentUser || !currentHousehold) {
                alert('Please sign in first');
                return;
            }

            // Check if user is admin
            const userRole = currentHousehold.members[currentUser.uid]?.role;
            if (userRole !== 'admin') {
                alert('Only household admins can invite new members');
                return;
            }

            document.getElementById('inviteModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('inviteEmail').focus();
            }, 300);
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
            document.getElementById('inviteForm').reset();
            hideInviteError();
        }

        // Handle invite form submission
        document.addEventListener('DOMContentLoaded', () => {
            const inviteForm = document.getElementById('inviteForm');
            if (inviteForm) {
                inviteForm.addEventListener('submit', handleInviteSubmit);
            }
        });

        async function handleInviteSubmit(e) {
            e.preventDefault();

            const email = document.getElementById('inviteEmail').value.trim();
            const message = document.getElementById('inviteMessage').value.trim();

            if (!email) {
                showInviteError('Please enter an email address');
                return;
            }

            // Check if user is already in household
            const members = Object.values(currentHousehold.members || {});
            if (members.some(member => member.email === email)) {
                showInviteError('This person is already a member of your household');
                return;
            }

            await sendInvitation(email, message);
        }

        async function sendInvitation(email, message) {
            if (!window.db || !currentUser || !currentHousehold) {
                showInviteError('Unable to send invitation');
                return;
            }

            try {
                // Create invitation document
                const invitationRef = window.firestoreUtils.collection(window.db, 'invitations');
                const invitationDoc = await window.firestoreUtils.addDoc(invitationRef, {
                    householdId: currentHousehold.id,
                    householdName: currentHousehold.name,
                    invitedBy: currentUser.uid,
                    invitedByName: currentUser.displayName || currentUser.email.split('@')[0],
                    invitedByEmail: currentUser.email,
                    invitedEmail: email,
                    message: message || `Join our family's FreshKeep household to share our food inventory!`,
                    status: 'pending',
                    createdAt: new Date(),
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
                });

                console.log('Invitation sent:', invitationDoc.id);

                // Show success message
                alert(`Invitation sent to ${email}! They will receive instructions via email.`);
                closeInviteModal();

                // In a real implementation, you would send an email here
                // For now, we'll simulate this by showing the invitation link
                const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${invitationDoc.id}`;
                console.log('Invitation link:', inviteLink);

                // Show the invitation link to the user
                setTimeout(() => {
                    if (confirm('Copy invitation link to share manually?')) {
                        navigator.clipboard.writeText(inviteLink).then(() => {
                            alert('Invitation link copied to clipboard!');
                        }).catch(() => {
                            prompt('Copy this invitation link:', inviteLink);
                        });
                    }
                }, 500);

            } catch (error) {
                console.error('Error sending invitation:', error);
                showInviteError('Failed to send invitation. Please try again.');
            }
        }

        function showInviteError(message) {
            const errorDiv = document.getElementById('inviteError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideInviteError() {
            document.getElementById('inviteError').style.display = 'none';
        }

        // Handle invitation acceptance from URL
        async function checkForInvitation() {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteId = urlParams.get('invite');

            if (inviteId && window.db) {
                try {
                    const inviteRef = window.firestoreUtils.doc(window.db, 'invitations', inviteId);
                    const inviteDoc = await window.firestoreUtils.getDoc(inviteRef);

                    if (inviteDoc.exists()) {
                        const invitation = inviteDoc.data();

                        if (invitation.status === 'pending') {
                            // Show invitation acceptance dialog
                            const accept = confirm(
                                `${invitation.invitedByName} has invited you to join "${invitation.householdName}".\n\n` +
                                `Message: ${invitation.message}\n\n` +
                                `Would you like to join this household?`
                            );

                            if (accept) {
                                if (currentUser) {
                                    await acceptInvitation(inviteId, invitation);
                                } else {
                                    // Store invitation to accept after sign in
                                    localStorage.setItem('pendingInvite', inviteId);
                                    showAuthModal();
                                }
                            }
                        } else {
                            alert('This invitation has already been used or has expired.');
                        }
                    } else {
                        alert('Invalid invitation link.');
                    }
                } catch (error) {
                    console.error('Error checking invitation:', error);
                    alert('Error processing invitation.');
                }

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function acceptInvitation(inviteId, invitation) {
            if (!window.db || !currentUser) return;

            try {
                // Add user to household
                const householdRef = window.firestoreUtils.doc(window.db, 'households', invitation.householdId);
                await window.firestoreUtils.updateDoc(householdRef, {
                    [`members.${currentUser.uid}`]: {
                        role: 'member',
                        joinedAt: new Date(),
                        displayName: currentUser.displayName || currentUser.email.split('@')[0],
                        email: currentUser.email
                    }
                });

                // Update user document
                const userDocRef = window.firestoreUtils.doc(window.db, 'users', currentUser.uid);
                await window.firestoreUtils.setDoc(userDocRef, {
                    householdId: invitation.householdId,
                    email: currentUser.email,
                    displayName: currentUser.displayName || currentUser.email.split('@')[0],
                    lastActive: new Date()
                }, { merge: true });

                // Mark invitation as accepted
                const inviteRef = window.firestoreUtils.doc(window.db, 'invitations', inviteId);
                await window.firestoreUtils.updateDoc(inviteRef, {
                    status: 'accepted',
                    acceptedAt: new Date(),
                    acceptedBy: currentUser.uid
                });

                // Load the new household
                await loadHousehold(invitation.householdId);
                await loadHouseholdFoodItems();

                alert(`Welcome to ${invitation.householdName}!`);

            } catch (error) {
                console.error('Error accepting invitation:', error);
                alert('Error joining household. Please try again.');
            }
        }

        // Guest Sharing System
        let currentGuestToken = null;

        function showGuestShareModal() {
            if (!currentUser || !currentHousehold) {
                alert('Please sign in first');
                return;
            }

            document.getElementById('guestShareModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('guestName').focus();
            }, 300);
        }

        function closeGuestShareModal() {
            document.getElementById('guestShareModal').style.display = 'none';
            document.getElementById('guestShareForm').reset();
            document.getElementById('guestLinkResult').style.display = 'none';
            hideGuestShareError();
            currentGuestToken = null;
        }

        // Handle guest share form submission
        document.addEventListener('DOMContentLoaded', () => {
            const guestShareForm = document.getElementById('guestShareForm');
            if (guestShareForm) {
                guestShareForm.addEventListener('submit', handleGuestShareSubmit);
            }
        });

        async function handleGuestShareSubmit(e) {
            e.preventDefault();

            const guestName = document.getElementById('guestName').value.trim();
            const duration = parseInt(document.getElementById('guestDuration').value);
            const permissions = {
                canViewExpiry: document.getElementById('guestCanViewExpiry').checked,
                canViewLocation: document.getElementById('guestCanViewLocation').checked,
                canViewDetails: document.getElementById('guestCanViewDetails').checked
            };

            await createGuestToken(guestName, duration, permissions);
        }

        async function createGuestToken(guestName, duration, permissions) {
            if (!window.db || !currentUser || !currentHousehold) {
                showGuestShareError('Unable to create guest link');
                return;
            }

            try {
                // Generate a unique token
                const tokenId = generateRandomToken();
                const expiresAt = new Date(Date.now() + duration * 60 * 60 * 1000); // hours to milliseconds

                // Create guest token document
                const guestTokenRef = window.firestoreUtils.doc(window.db, 'guestTokens', tokenId);
                await window.firestoreUtils.setDoc(guestTokenRef, {
                    householdId: currentHousehold.id,
                    householdName: currentHousehold.name,
                    createdBy: currentUser.uid,
                    createdByName: currentUser.displayName || currentUser.email.split('@')[0],
                    guestName: guestName || 'Guest User',
                    permissions: permissions,
                    createdAt: new Date(),
                    expiresAt: expiresAt,
                    active: true,
                    accessCount: 0
                });

                currentGuestToken = tokenId;

                // Generate and show the guest link
                const guestLink = `${window.location.origin}${window.location.pathname}?guest=${tokenId}`;

                document.getElementById('guestLinkUrl').textContent = guestLink;
                document.getElementById('guestLinkResult').style.display = 'block';

                console.log('Guest token created:', tokenId);

            } catch (error) {
                console.error('Error creating guest token:', error);
                showGuestShareError('Failed to create guest link. Please try again.');
            }
        }

        function generateRandomToken() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 32; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function copyGuestLink() {
            const linkUrl = document.getElementById('guestLinkUrl').textContent;
            try {
                await navigator.clipboard.writeText(linkUrl);
                alert('Guest link copied to clipboard!');
            } catch (error) {
                // Fallback for older browsers
                prompt('Copy this guest link:', linkUrl);
            }
        }

        async function revokeGuestLink() {
            if (!currentGuestToken || !window.db) return;

            try {
                const guestTokenRef = window.firestoreUtils.doc(window.db, 'guestTokens', currentGuestToken);
                await window.firestoreUtils.updateDoc(guestTokenRef, {
                    active: false,
                    revokedAt: new Date()
                });

                alert('Guest link has been revoked');
                closeGuestShareModal();

            } catch (error) {
                console.error('Error revoking guest token:', error);
                alert('Error revoking guest link');
            }
        }

        function showGuestShareError(message) {
            const errorDiv = document.getElementById('guestShareError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideGuestShareError() {
            document.getElementById('guestShareError').style.display = 'none';
        }

        // Guest access handling
        let guestPermissions = null;
        let isGuestMode = false;

        async function checkForGuestAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const guestToken = urlParams.get('guest');

            if (guestToken && window.db) {
                try {
                    const tokenRef = window.firestoreUtils.doc(window.db, 'guestTokens', guestToken);
                    const tokenDoc = await window.firestoreUtils.getDoc(tokenRef);

                    if (tokenDoc.exists()) {
                        const tokenData = tokenDoc.data();

                        // Check if token is valid and not expired
                        if (tokenData.active && new Date() < tokenData.expiresAt.toDate()) {
                            // Enable guest mode
                            isGuestMode = true;
                            guestPermissions = tokenData.permissions;

                            // Update access count
                            await window.firestoreUtils.updateDoc(tokenRef, {
                                accessCount: (tokenData.accessCount || 0) + 1,
                                lastAccessed: new Date()
                            });

                            // Load household data for guest view
                            await loadGuestHouseholdData(tokenData.householdId, tokenData);

                            // Update UI for guest mode
                            setupGuestUI(tokenData);

                            return true;
                        } else {
                            alert('This guest link has expired or been revoked.');
                        }
                    } else {
                        alert('Invalid guest link.');
                    }
                } catch (error) {
                    console.error('Error checking guest access:', error);
                    alert('Error processing guest link.');
                }

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            return false;
        }

        async function loadGuestHouseholdData(householdId, tokenData) {
            try {
                // Load food items for guest view
                const foodItemsRef = window.firestoreUtils.collection(window.db, 'foodItems');
                const q = window.firestoreUtils.query(
                    foodItemsRef,
                    window.firestoreUtils.where('householdId', '==', householdId)
                );

                const snapshot = await window.firestoreUtils.getDocs(q);
                const items = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = {
                        ...data,
                        firestoreId: doc.id,
                        storedDate: new Date(data.storedDate),
                        addedDate: new Date(data.addedDate)
                    };
                    items.push(item);
                });

                foodItems = items;
                updateDisplay();

                console.log('Loaded guest household data:', items.length, 'items');

            } catch (error) {
                console.error('Error loading guest household data:', error);
            }
        }

        function setupGuestUI(tokenData) {
            // Update header to show guest mode
            const header = document.querySelector('.header p');
            if (header) {
                header.innerHTML = `
                    🔗 Guest View: ${tokenData.householdName}<br>
                    <span style="font-size: 14px; opacity: 0.8;">
                        Welcome ${tokenData.guestName} - Read-only access expires ${tokenData.expiresAt.toDate().toLocaleDateString()}
                    </span>
                `;
            }

            // Hide add form for guests
            const addForm = document.querySelector('.add-form');
            if (addForm) {
                addForm.style.display = 'none';
            }

            // Hide user profile button
            const userProfileBtn = document.getElementById('userProfileBtn');
            if (userProfileBtn) {
                userProfileBtn.style.display = 'none';
            }

            // Add guest indicator to connection status
            updateConnectionStatus('guest');
        }

        function showHouseholdSettings() {
            if (!currentUser || !currentHousehold) {
                alert('Please sign in and join a household first');
                return;
            }

            document.getElementById('householdSettingsModal').style.display = 'flex';
            loadHouseholdSettingsData();
        }

        function closeHouseholdSettings() {
            document.getElementById('householdSettingsModal').style.display = 'none';
        }

        function switchSettingsTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.settings-tab[onclick="switchSettingsTab('${tabName}')"]`).classList.add('active');

            // Update panels
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`settings${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'members') {
                loadHouseholdMembers();
            } else if (tabName === 'invitations') {
                loadPendingInvitations();
            } else if (tabName === 'guests') {
                loadActiveGuestTokens();
            } else if (tabName === 'advanced') {
                loadCustomCategories();
            }
        }

        async function loadHouseholdSettingsData() {
            // Load current household data into form fields
            if (currentHousehold) {
                document.getElementById('householdNameEdit').value = currentHousehold.name || '';
                document.getElementById('householdTimezone').value = currentHousehold.timezone || 'America/New_York';

                // Load storage durations
                const durations = currentHousehold.storageDurations || {};
                document.getElementById('durationFruits').value = durations.fruits || 7;
                document.getElementById('durationVegetables').value = durations.vegetables || 7;
                document.getElementById('durationDairy').value = durations.dairy || 10;
                document.getElementById('durationMeat').value = durations.meat || 5;
                document.getElementById('durationLeftovers').value = durations.leftovers || 3;
                document.getElementById('durationOther').value = durations.other || 14;
            }

            // Load default data for active tab
            loadHouseholdMembers();
        }

        async function loadHouseholdMembers() {
            if (!window.db || !currentHousehold) return;

            try {
                const membersList = document.getElementById('membersList');
                membersList.innerHTML = '<div class="loading">Loading members...</div>';

                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                const householdDoc = await window.firestoreUtils.getDoc(householdRef);

                if (householdDoc.exists()) {
                    const data = householdDoc.data();
                    const members = data.members || {};

                    let membersHtml = '';
                    for (const [uid, member] of Object.entries(members)) {
                        const isCurrentUser = uid === currentUser.uid;
                        const isAdmin = member.role === 'admin';

                        membersHtml += `
                            <div class="member-item">
                                <div class="member-info">
                                    <strong>${member.name}${isCurrentUser ? ' (You)' : ''}</strong>
                                    <span class="member-role ${member.role}">${member.role}</span>
                                    <div class="member-meta">
                                        Joined ${new Date(member.joinedAt.toDate()).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="member-actions">
                                    ${!isCurrentUser && currentHousehold.role === 'admin' ? `
                                        <select onchange="changeMemberRole('${uid}', this.value)" aria-label="Change role for ${member.name}" class="role-select">
                                            <option value="member" ${member.role === 'member' ? 'selected' : ''}>Member</option>
                                            <option value="admin" ${member.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        </select>
                                        <button class="settings-btn danger small" onclick="removeMember('${uid}', '${member.name}')" aria-label="Remove ${member.name} from household">Remove</button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }

                    membersList.innerHTML = membersHtml || '<div class="empty-state">No members found</div>';
                }
            } catch (error) {
                console.error('Error loading household members:', error);
                document.getElementById('membersList').innerHTML = '<div class="error">Error loading members</div>';
            }
        }

        async function changeMemberRole(uid, newRole) {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can change member roles');
                return;
            }

            try {
                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                await window.firestoreUtils.updateDoc(householdRef, {
                    [`members.${uid}.role`]: newRole,
                    [`members.${uid}.roleChangedAt`]: new Date(),
                    [`members.${uid}.roleChangedBy`]: currentUser.uid
                });

                alert(`Member role updated to ${newRole}`);
                loadHouseholdMembers(); // Refresh the list
            } catch (error) {
                console.error('Error changing member role:', error);
                alert('Error updating member role');
            }
        }

        async function removeMember(uid, memberName) {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can remove members');
                return;
            }

            if (!confirm(`Are you sure you want to remove ${memberName} from the household? This action cannot be undone.`)) {
                return;
            }

            try {
                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                await window.firestoreUtils.updateDoc(householdRef, {
                    [`members.${uid}`]: window.firestoreUtils.deleteField()
                });

                alert(`${memberName} has been removed from the household`);
                loadHouseholdMembers(); // Refresh the list
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Error removing member');
            }
        }

        async function saveHouseholdSettings() {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can modify household settings');
                return;
            }

            try {
                const newName = document.getElementById('householdNameEdit').value.trim();
                const timezone = document.getElementById('householdTimezone').value;

                const storageDurations = {
                    fruits: parseInt(document.getElementById('durationFruits').value),
                    vegetables: parseInt(document.getElementById('durationVegetables').value),
                    dairy: parseInt(document.getElementById('durationDairy').value),
                    meat: parseInt(document.getElementById('durationMeat').value),
                    leftovers: parseInt(document.getElementById('durationLeftovers').value),
                    other: parseInt(document.getElementById('durationOther').value)
                };

                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                await window.firestoreUtils.updateDoc(householdRef, {
                    name: newName,
                    timezone: timezone,
                    storageDurations: storageDurations,
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid
                });

                // Update local household data
                currentHousehold.name = newName;
                currentHousehold.timezone = timezone;
                currentHousehold.storageDurations = storageDurations;

                alert('Household settings saved successfully!');
            } catch (error) {
                console.error('Error saving household settings:', error);
                alert('Error saving household settings');
            }
        }

        async function loadPendingInvitations() {
            if (!window.db || !currentHousehold) return;

            try {
                const invitationsList = document.getElementById('pendingInvitationsList');
                invitationsList.innerHTML = '<div class="loading">Loading pending invitations...</div>';

                const invitationsRef = window.firestoreUtils.collection(window.db, 'invitations');
                const q = window.firestoreUtils.query(
                    invitationsRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id),
                    window.firestoreUtils.where('status', '==', 'pending')
                );

                const snapshot = await window.firestoreUtils.getDocs(q);
                let invitationsHtml = '';

                snapshot.forEach((doc) => {
                    const invitation = doc.data();
                    const expiresAt = new Date(invitation.expiresAt.toDate());
                    const isExpired = expiresAt < new Date();

                    invitationsHtml += `
                        <div class="invitation-item ${isExpired ? 'expired' : ''}">
                            <div class="invitation-info">
                                <strong>${invitation.email}</strong>
                                <div class="invitation-meta">
                                    Invited by ${invitation.invitedByName} on ${new Date(invitation.createdAt.toDate()).toLocaleDateString()}
                                    <br>
                                    ${isExpired ? 'Expired' : 'Expires'} ${expiresAt.toLocaleDateString()}
                                </div>
                            </div>
                            <div class="invitation-actions">
                                <button class="settings-btn danger small" onclick="cancelInvitation('${doc.id}', '${invitation.email}')">
                                    Cancel
                                </button>
                                ${isExpired ? '' : `
                                    <button class="settings-btn primary small" onclick="resendInvitation('${doc.id}', '${invitation.email}')">
                                        Resend
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                });

                invitationsList.innerHTML = invitationsHtml || '<div class="empty-state">No pending invitations</div>';
            } catch (error) {
                console.error('Error loading pending invitations:', error);
                document.getElementById('pendingInvitationsList').innerHTML = '<div class="error">Error loading invitations</div>';
            }
        }

        async function cancelInvitation(invitationId, email) {
            if (!confirm(`Cancel invitation for ${email}?`)) return;

            try {
                const invitationRef = window.firestoreUtils.doc(window.db, 'invitations', invitationId);
                await window.firestoreUtils.updateDoc(invitationRef, {
                    status: 'cancelled',
                    cancelledAt: new Date(),
                    cancelledBy: currentUser.uid
                });

                alert('Invitation cancelled');
                loadPendingInvitations(); // Refresh the list
            } catch (error) {
                console.error('Error cancelling invitation:', error);
                alert('Error cancelling invitation');
            }
        }

        async function resendInvitation(invitationId, email) {
            try {
                // Extend expiration by 1 week
                const newExpiresAt = new Date();
                newExpiresAt.setDate(newExpiresAt.getDate() + 7);

                const invitationRef = window.firestoreUtils.doc(window.db, 'invitations', invitationId);
                await window.firestoreUtils.updateDoc(invitationRef, {
                    expiresAt: newExpiresAt,
                    resentAt: new Date(),
                    resentBy: currentUser.uid
                });

                alert(`Invitation resent to ${email} with new expiration date`);
                loadPendingInvitations(); // Refresh the list
            } catch (error) {
                console.error('Error resending invitation:', error);
                alert('Error resending invitation');
            }
        }

        async function saveInvitationSettings() {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can modify invitation settings');
                return;
            }

            try {
                const defaultExpiration = parseInt(document.getElementById('inviteExpiration').value);

                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                await window.firestoreUtils.updateDoc(householdRef, {
                    invitationSettings: {
                        defaultExpirationHours: defaultExpiration
                    },
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid
                });

                alert('Invitation settings saved!');
            } catch (error) {
                console.error('Error saving invitation settings:', error);
                alert('Error saving invitation settings');
            }
        }

        async function loadActiveGuestTokens() {
            if (!window.db || !currentHousehold) return;

            try {
                const guestsList = document.getElementById('activeGuestsList');
                guestsList.innerHTML = '<div class="loading">Loading active guest tokens...</div>';

                const guestTokensRef = window.firestoreUtils.collection(window.db, 'guestTokens');
                const q = window.firestoreUtils.query(
                    guestTokensRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id),
                    window.firestoreUtils.where('active', '==', true)
                );

                const snapshot = await window.firestoreUtils.getDocs(q);
                let guestsHtml = '';

                snapshot.forEach((doc) => {
                    const token = doc.data();
                    const expiresAt = new Date(token.expiresAt.toDate());
                    const isExpired = expiresAt < new Date();

                    guestsHtml += `
                        <div class="guest-token-item ${isExpired ? 'expired' : ''}">
                            <div class="guest-info">
                                <strong>${token.guestName}</strong>
                                <div class="guest-meta">
                                    Created by ${token.createdByName} on ${new Date(token.createdAt.toDate()).toLocaleDateString()}
                                    <br>
                                    ${isExpired ? 'Expired' : 'Expires'} ${expiresAt.toLocaleDateString()} at ${expiresAt.toLocaleTimeString()}
                                    <br>
                                    Access count: ${token.accessCount || 0}
                                    ${token.lastAccessed ? ` • Last used: ${new Date(token.lastAccessed.toDate()).toLocaleDateString()}` : ''}
                                </div>
                                <div class="guest-permissions">
                                    Permissions: ${Object.entries(token.permissions || {})
                                        .filter(([key, value]) => value)
                                        .map(([key]) => key.replace('canView', '').replace(/([A-Z])/g, ' $1').toLowerCase())
                                        .join(', ') || 'None'}
                                </div>
                            </div>
                            <div class="guest-actions">
                                <button class="settings-btn danger small" onclick="revokeGuestToken('${doc.id}', '${token.guestName}')">
                                    Revoke
                                </button>
                            </div>
                        </div>
                    `;
                });

                guestsList.innerHTML = guestsHtml || '<div class="empty-state">No active guest tokens</div>';
            } catch (error) {
                console.error('Error loading guest tokens:', error);
                document.getElementById('activeGuestsList').innerHTML = '<div class="error">Error loading guest tokens</div>';
            }
        }

        async function revokeGuestToken(tokenId, guestName) {
            if (!confirm(`Revoke guest access for ${guestName}?`)) return;

            try {
                const tokenRef = window.firestoreUtils.doc(window.db, 'guestTokens', tokenId);
                await window.firestoreUtils.updateDoc(tokenRef, {
                    active: false,
                    revokedAt: new Date(),
                    revokedBy: currentUser.uid
                });

                alert(`Guest access revoked for ${guestName}`);
                loadActiveGuestTokens(); // Refresh the list
            } catch (error) {
                console.error('Error revoking guest token:', error);
                alert('Error revoking guest access');
            }
        }

        async function revokeAllGuestTokens() {
            if (!confirm('Are you sure you want to revoke ALL guest access? This cannot be undone.')) return;

            try {
                const guestTokensRef = window.firestoreUtils.collection(window.db, 'guestTokens');
                const q = window.firestoreUtils.query(
                    guestTokensRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id),
                    window.firestoreUtils.where('active', '==', true)
                );

                const snapshot = await window.firestoreUtils.getDocs(q);
                const batch = window.firestoreUtils.writeBatch(window.db);

                snapshot.forEach((doc) => {
                    batch.update(doc.ref, {
                        active: false,
                        revokedAt: new Date(),
                        revokedBy: currentUser.uid,
                        batchRevoked: true
                    });
                });

                await batch.commit();
                alert(`Revoked ${snapshot.size} guest token(s)`);
                loadActiveGuestTokens(); // Refresh the list
            } catch (error) {
                console.error('Error revoking all guest tokens:', error);
                alert('Error revoking guest tokens');
            }
        }

        async function saveGuestSettings() {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can modify guest settings');
                return;
            }

            try {
                const defaultPermissions = {
                    canViewExpiry: document.getElementById('defaultGuestExpiry').checked,
                    canViewLocation: document.getElementById('defaultGuestLocation').checked,
                    canViewDetails: document.getElementById('defaultGuestDetails').checked
                };

                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                await window.firestoreUtils.updateDoc(householdRef, {
                    guestSettings: {
                        defaultPermissions: defaultPermissions
                    },
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid
                });

                alert('Guest settings saved!');
            } catch (error) {
                console.error('Error saving guest settings:', error);
                alert('Error saving guest settings');
            }
        }

        async function exportData(format) {
            if (!window.db || !currentHousehold) {
                alert('Cannot export data: not connected to household');
                return;
            }

            try {
                // Get all food items for this household
                const foodItemsRef = window.firestoreUtils.collection(window.db, 'foodItems');
                const q = window.firestoreUtils.query(
                    foodItemsRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id)
                );

                const snapshot = await window.firestoreUtils.getDocs(q);
                const items = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    items.push({
                        id: doc.id,
                        name: data.name,
                        category: data.category,
                        location: data.location,
                        storedDate: new Date(data.storedDate).toISOString(),
                        addedDate: new Date(data.addedDate).toISOString(),
                        addedBy: data.addedByName,
                        expiryDate: data.expiryDate,
                        consumed: data.consumed || false,
                        notes: data.notes || ''
                    });
                });

                if (format === 'csv') {
                    const csv = convertToCSV(items);
                    downloadFile(csv, 'freshkeep-data.csv', 'text/csv');
                } else if (format === 'json') {
                    const json = JSON.stringify(items, null, 2);
                    downloadFile(json, 'freshkeep-data.json', 'application/json');
                }

                alert(`Data exported successfully (${items.length} items)`);
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data');
            }
        }

        function convertToCSV(items) {
            if (items.length === 0) return '';

            const headers = Object.keys(items[0]);
            const csvContent = [
                headers.join(','),
                ...items.map(item =>
                    headers.map(field => {
                        const value = item[field] || '';
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');

            return csvContent;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function saveDataSettings() {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can modify data settings');
                return;
            }

            try {
                const autoDeleteDays = parseInt(document.getElementById('autoDeleteDays').value);

                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                await window.firestoreUtils.updateDoc(householdRef, {
                    dataSettings: {
                        autoDeleteDays: autoDeleteDays
                    },
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid
                });

                alert('Data retention settings saved!');
            } catch (error) {
                console.error('Error saving data settings:', error);
                alert('Error saving data settings');
            }
        }

        async function savePrivacySettings() {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can modify privacy settings');
                return;
            }

            try {
                const privacySettings = {
                    shareUsageStats: document.getElementById('shareUsageStats').checked,
                    allowAnalytics: document.getElementById('allowAnalytics').checked
                };

                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                await window.firestoreUtils.updateDoc(householdRef, {
                    privacySettings: privacySettings,
                    updatedAt: new Date(),
                    updatedBy: currentUser.uid
                });

                alert('Privacy settings saved!');
            } catch (error) {
                console.error('Error saving privacy settings:', error);
                alert('Error saving privacy settings');
            }
        }

        async function loadCustomCategories() {
            if (!window.db || !currentHousehold) return;

            try {
                const categoriesList = document.getElementById('customCategoriesList');
                categoriesList.innerHTML = '<div class="loading">Loading custom categories...</div>';

                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                const householdDoc = await window.firestoreUtils.getDoc(householdRef);

                if (householdDoc.exists()) {
                    const data = householdDoc.data();
                    const customCategories = data.customCategories || [];

                    let categoriesHtml = '';
                    customCategories.forEach((category, index) => {
                        categoriesHtml += `
                            <div class="category-item">
                                <span class="category-name">${category}</span>
                                ${currentHousehold.role === 'admin' ? `
                                    <button class="settings-btn danger small" onclick="removeCustomCategory('${category}', ${index})">
                                        Remove
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    });

                    categoriesList.innerHTML = categoriesHtml || '<div class="empty-state">No custom categories</div>';
                }
            } catch (error) {
                console.error('Error loading custom categories:', error);
                document.getElementById('customCategoriesList').innerHTML = '<div class="error">Error loading categories</div>';
            }
        }

        async function addCustomCategory() {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can add custom categories');
                return;
            }

            const categoryInput = document.getElementById('newCategoryName');
            const categoryName = categoryInput.value.trim();

            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            try {
                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                const householdDoc = await window.firestoreUtils.getDoc(householdRef);

                if (householdDoc.exists()) {
                    const data = householdDoc.data();
                    const customCategories = data.customCategories || [];

                    if (customCategories.includes(categoryName)) {
                        alert('Category already exists');
                        return;
                    }

                    customCategories.push(categoryName);

                    await window.firestoreUtils.updateDoc(householdRef, {
                        customCategories: customCategories,
                        updatedAt: new Date(),
                        updatedBy: currentUser.uid
                    });

                    categoryInput.value = '';
                    alert(`Category "${categoryName}" added successfully`);
                    loadCustomCategories(); // Refresh the list
                }
            } catch (error) {
                console.error('Error adding custom category:', error);
                alert('Error adding custom category');
            }
        }

        async function removeCustomCategory(categoryName, index) {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can remove custom categories');
                return;
            }

            if (!confirm(`Remove category "${categoryName}"? Items using this category will need to be recategorized.`)) {
                return;
            }

            try {
                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                const householdDoc = await window.firestoreUtils.getDoc(householdRef);

                if (householdDoc.exists()) {
                    const data = householdDoc.data();
                    const customCategories = data.customCategories || [];
                    customCategories.splice(index, 1);

                    await window.firestoreUtils.updateDoc(householdRef, {
                        customCategories: customCategories,
                        updatedAt: new Date(),
                        updatedBy: currentUser.uid
                    });

                    alert(`Category "${categoryName}" removed successfully`);
                    loadCustomCategories(); // Refresh the list
                }
            } catch (error) {
                console.error('Error removing custom category:', error);
                alert('Error removing custom category');
            }
        }

        async function confirmDeleteHousehold() {
            if (!window.db || !currentHousehold || currentHousehold.role !== 'admin') {
                alert('Only admins can delete the household');
                return;
            }

            const confirmText = prompt(`This will permanently delete the entire household and all data. This cannot be undone.\n\nType "${currentHousehold.name}" to confirm:`);

            if (confirmText !== currentHousehold.name) {
                alert('Household name does not match. Deletion cancelled.');
                return;
            }

            try {
                // Delete all food items
                const foodItemsRef = window.firestoreUtils.collection(window.db, 'foodItems');
                const foodQuery = window.firestoreUtils.query(
                    foodItemsRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id)
                );
                const foodSnapshot = await window.firestoreUtils.getDocs(foodQuery);

                // Delete all invitations
                const invitationsRef = window.firestoreUtils.collection(window.db, 'invitations');
                const inviteQuery = window.firestoreUtils.query(
                    invitationsRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id)
                );
                const inviteSnapshot = await window.firestoreUtils.getDocs(inviteQuery);

                // Delete all guest tokens
                const guestTokensRef = window.firestoreUtils.collection(window.db, 'guestTokens');
                const guestQuery = window.firestoreUtils.query(
                    guestTokensRef,
                    window.firestoreUtils.where('householdId', '==', currentHousehold.id)
                );
                const guestSnapshot = await window.firestoreUtils.getDocs(guestQuery);

                // Use batch operations for efficiency
                const batch = window.firestoreUtils.writeBatch(window.db);

                // Add all deletions to batch
                foodSnapshot.forEach((doc) => batch.delete(doc.ref));
                inviteSnapshot.forEach((doc) => batch.delete(doc.ref));
                guestSnapshot.forEach((doc) => batch.delete(doc.ref));

                // Delete the household itself
                const householdRef = window.firestoreUtils.doc(window.db, 'households', currentHousehold.id);
                batch.delete(householdRef);

                // Commit all deletions
                await batch.commit();

                // Reset local state
                currentHousehold = null;
                foodItems = [];
                updateDisplay();
                updateConnectionStatus('disconnected');

                alert('Household deleted successfully. You will need to create or join a new household.');
                closeHouseholdSettings();

            } catch (error) {
                console.error('Error deleting household:', error);
                alert('Error deleting household. Please try again.');
            }
        }

        // Handle Enter key in new category input
        document.addEventListener('DOMContentLoaded', () => {
            const newCategoryInput = document.getElementById('newCategoryName');
            if (newCategoryInput) {
                newCategoryInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addCustomCategory();
                    }
                });
            }
        });

        // Theme Management
        function initializeTheme() {
            // Check for saved theme preference or default to 'light' mode
            const savedTheme = localStorage.getItem('freshkeep-theme');
            const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            let theme = savedTheme;
            if (!theme) {
                theme = systemPrefersDark ? 'dark' : 'light';
            }

            setTheme(theme);

            // Listen for system theme changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem('freshkeep-theme')) {
                        setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }
        }

        function setTheme(theme) {
            const html = document.documentElement;
            const themeIcon = document.querySelector('.theme-icon');

            if (theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
                if (themeIcon) themeIcon.textContent = '☀️';
            } else {
                html.removeAttribute('data-theme');
                if (themeIcon) themeIcon.textContent = '🌙';
            }

            // Update meta theme-color for mobile browsers
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (metaThemeColor) {
                metaThemeColor.setAttribute('content', theme === 'dark' ? '#121212' : '#667eea');
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            setTheme(newTheme);
            localStorage.setItem('freshkeep-theme', newTheme);

            // Add a subtle animation to indicate the change
            const themeToggle = document.querySelector('.theme-toggle');
            if (themeToggle) {
                themeToggle.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    themeToggle.style.transform = '';
                }, 150);
            }
        }

        // Firestore service functions
        const FirestoreService = {
            // Save a food item to Firestore
            async saveFoodItem(item) {
                if (!window.db) {
                    console.log('Firestore not available, using local storage');
                    return this.saveToLocalStorage(item);
                }

                try {
                    // Convert dates to Firestore timestamps and add household info
                    const firestoreItem = {
                        ...item,
                        householdId: currentHousehold ? currentHousehold.id : null,
                        addedBy: currentUser ? currentUser.uid : null,
                        addedByName: currentUser ? (currentUser.displayName || currentUser.email.split('@')[0]) : 'Anonymous',
                        storedDate: item.storedDate.toISOString(),
                        addedDate: item.addedDate.toISOString()
                    };

                    const docRef = await window.firestoreUtils.addDoc(
                        window.firestoreUtils.collection(window.db, 'foodItems'),
                        firestoreItem
                    );

                    // Update local item with Firestore ID
                    item.firestoreId = docRef.id;
                    console.log('Food item saved to Firestore:', docRef.id);
                    return docRef.id;
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Fallback to local storage
                    return this.saveToLocalStorage(item);
                }
            },

            // Load all food items from Firestore
            async loadFoodItems() {
                if (!window.db) {
                    console.log('Firestore not available, using local storage');
                    return this.loadFromLocalStorage();
                }

                try {
                    const querySnapshot = await window.firestoreUtils.getDocs(
                        window.firestoreUtils.collection(window.db, 'foodItems')
                    );

                    const items = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const item = {
                            ...data,
                            firestoreId: doc.id,
                            storedDate: new Date(data.storedDate),
                            addedDate: new Date(data.addedDate)
                        };
                        items.push(item);
                    });

                    console.log('Loaded', items.length, 'items from Firestore');
                    return items;
                } catch (error) {
                    console.error('Error loading from Firestore:', error);
                    // Fallback to local storage
                    return this.loadFromLocalStorage();
                }
            },

            // Delete a food item from Firestore
            async deleteFoodItem(item) {
                if (!window.db || !item.firestoreId) {
                    console.log('Firestore not available or no Firestore ID, using local storage');
                    return this.deleteFromLocalStorage(item);
                }

                try {
                    await window.firestoreUtils.deleteDoc(
                        window.firestoreUtils.doc(window.db, 'foodItems', item.firestoreId)
                    );
                    console.log('Food item deleted from Firestore:', item.firestoreId);
                    return true;
                } catch (error) {
                    console.error('Error deleting from Firestore:', error);
                    return this.deleteFromLocalStorage(item);
                }
            },

            // Setup real-time listener for food items
            setupRealtimeListener() {
                if (!window.db) {
                    console.log('Firestore not available, skipping real-time listener');
                    return;
                }

                try {
                    const unsubscribe = window.firestoreUtils.onSnapshot(
                        window.firestoreUtils.collection(window.db, 'foodItems'),
                        (snapshot) => {
                            const items = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                const item = {
                                    ...data,
                                    firestoreId: doc.id,
                                    storedDate: new Date(data.storedDate),
                                    addedDate: new Date(data.addedDate)
                                };
                                items.push(item);
                            });

                            foodItems = items;
                            updateDisplay();
                            console.log('Real-time update: loaded', items.length, 'items');
                        },
                        (error) => {
                            console.error('Real-time listener error:', error);
                        }
                    );

                    // Store unsubscribe function globally for cleanup
                    window.firestoreUnsubscribe = unsubscribe;
                } catch (error) {
                    console.error('Error setting up real-time listener:', error);
                }
            },

            // Local storage fallback methods
            saveToLocalStorage(item) {
                const stored = localStorage.getItem('freshkeep-items') || '[]';
                const items = JSON.parse(stored);

                // Convert dates to strings for storage
                const storageItem = {
                    ...item,
                    storedDate: item.storedDate.toISOString(),
                    addedDate: item.addedDate.toISOString()
                };

                items.push(storageItem);
                localStorage.setItem('freshkeep-items', JSON.stringify(items));
                console.log('Saved to local storage');
                return item.id;
            },

            loadFromLocalStorage() {
                const stored = localStorage.getItem('freshkeep-items') || '[]';
                const items = JSON.parse(stored);

                return items.map(item => ({
                    ...item,
                    storedDate: new Date(item.storedDate),
                    addedDate: new Date(item.addedDate)
                }));
            },

            deleteFromLocalStorage(item) {
                const stored = localStorage.getItem('freshkeep-items') || '[]';
                const items = JSON.parse(stored);
                const filtered = items.filter(storedItem => storedItem.id !== item.id);
                localStorage.setItem('freshkeep-items', JSON.stringify(filtered));
                console.log('Deleted from local storage');
                return true;
            }
        };

        // Storage guidelines (months) - varies by location
        const storageGuidelines = {
            'Pantry': {
                'Meat': 0, 'Vegetables': 12, 'Dairy': 0, 'Grains': 24, 'Canned': 36, 
                'Snacks': 12, 'Condiments': 24, 'Beverages': 12, 'Desserts': 12, 
                'Prepared': 6, 'Other': 12
            },
            'Fridge': {
                'Meat': 0.25, 'Vegetables': 2, 'Dairy': 1, 'Grains': 1, 'Canned': 0.5,
                'Snacks': 3, 'Condiments': 6, 'Beverages': 1, 'Desserts': 1, 
                'Prepared': 0.25, 'Other': 1
            },
            'Freezer': {
                'Meat': 6, 'Vegetables': 12, 'Dairy': 3, 'Grains': 6, 'Canned': 0,
                'Snacks': 6, 'Condiments': 12, 'Beverages': 6, 'Desserts': 4, 
                'Prepared': 3, 'Other': 6
            }
        };

        // Initialize app after DOM loads
        window.addEventListener('DOMContentLoaded', async function() {
            // Initialize theme first
            initializeTheme();

            // Initialize authentication
            initializeAuth();

            document.getElementById('storedDate').valueAsDate = new Date();

            // Check for guest access first
            const isGuest = await checkForGuestAccess();

            if (!isGuest) {
                // Check for invitation in URL
                await checkForInvitation();

                // Show auth modal after a short delay if not authenticated
                setTimeout(() => {
                    if (!isAuthenticated && window.auth) {
                        showAuthModal();
                    } else if (!window.auth) {
                        // If Firebase is not available, load from localStorage
                        loadLocalStorageItems();
                    }
                }, 1000);
            }
        });

        function toggleScanner() {
            if (isScanning) {
                stopScanner();
            } else {
                isBatchMode = false;
                startScanner();
            }
        }

        function toggleBatchMode() {
            if (isScanning && isBatchMode) {
                stopScanner();
            } else {
                isBatchMode = true;
                document.getElementById('batchQueue').style.display = 'block';
                startScanner();
            }
        }

        function toggleManualEntry() {
            const manualEntry = document.getElementById('manualEntry');
            const isVisible = manualEntry.style.display !== 'none';
            manualEntry.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                document.getElementById('manualBarcode').focus();
            }
        }

        function toggleDateField() {
            const location = document.getElementById('storageLocation').value;
            const dateLabel = document.getElementById('dateLabel');
            
            if (location === 'Freezer') {
                dateLabel.textContent = 'Date Frozen';
            } else {
                dateLabel.textContent = 'Date Added';
            }
        }

        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('category').value;
            const location = document.getElementById('storageLocation').value;
            const storedDate = document.getElementById('storedDate').value;

            if (!name || !storedDate) {
                alert('Please fill in all fields!');
                return;
            }

            const dateParts = storedDate.split('-');
            const localDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);

            const item = {
                id: Date.now(),
                name: name,
                category: category,
                location: location,
                storedDate: localDate,
                addedDate: new Date()
            };

            try {
                // Save to Firestore
                await FirestoreService.saveFoodItem(item);

                // If not using real-time listener, add to local array
                if (!window.firestoreUnsubscribe) {
                    foodItems.push(item);
                    updateDisplay();
                }

                document.getElementById('itemName').value = '';
                document.getElementById('storedDate').valueAsDate = new Date();
            } catch (error) {
                console.error('Error adding item:', error);
                alert('Error adding item. Please try again.');
            }
        }

        async function deleteItem(id) {
            try {
                // Find the item to delete
                const itemToDelete = foodItems.find(item => item.id === id);
                if (!itemToDelete) {
                    console.error('Item not found:', id);
                    return;
                }

                // Delete from Firestore
                await FirestoreService.deleteFoodItem(itemToDelete);

                // If not using real-time listener, remove from local array
                if (!window.firestoreUnsubscribe) {
                    foodItems = foodItems.filter(item => item.id !== id);
                    updateDisplay();
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Error deleting item. Please try again.');
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            updateDisplay();
        }

        function handleSearch() {
            searchTerm = document.getElementById('searchBox').value.toLowerCase();
            updateDisplay();
        }

        function handleSort() {
            sortBy = document.getElementById('sortSelect').value;
            updateDisplay();
        }

        function clearSearch() {
            document.getElementById('searchBox').value = '';
            document.getElementById('sortSelect').value = 'expiration';
            searchTerm = '';
            sortBy = 'expiration';
            updateDisplay();
        }

        function filterAndSortItems(items) {
            let filteredItems = items;

            // Filter by search term
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.category.toLowerCase().includes(searchTerm)
                );
            }

            // Filter by current tab
            if (currentTab !== 'all') {
                filteredItems = filteredItems.filter(item => 
                    item.location.toLowerCase() === currentTab
                );
            }

            // Sort items
            filteredItems.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'date-added':
                        return b.addedDate - a.addedDate;
                    case 'location':
                        return a.location.localeCompare(b.location);
                    case 'category':
                        return a.category.localeCompare(b.category);
                    case 'expiration':
                    default:
                        const statusA = getItemStatus(a);
                        const statusB = getItemStatus(b);
                        const statusOrder = { expired: 0, warning: 1, fresh: 2 };
                        return statusOrder[statusA.status] - statusOrder[statusB.status];
                }
            });

            return filteredItems;
        }

        function getDaysInStorage(storedDate) {
            const now = new Date();
            const diffTime = Math.abs(now - storedDate);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getItemStatus(item) {
            const daysInStorage = getDaysInStorage(item.storedDate);
            const maxDays = storageGuidelines[item.location][item.category] * 30;
            
            if (maxDays === 0) {
                return { status: 'warning', daysLeft: 0, message: 'Not recommended for this location!' };
            }
            
            const warningDays = maxDays * 0.8;

            if (daysInStorage >= maxDays) {
                return { status: 'expired', daysLeft: 0, message: 'Use immediately!' };
            } else if (daysInStorage >= warningDays) {
                return { status: 'warning', daysLeft: maxDays - daysInStorage, message: `Use within ${maxDays - daysInStorage} days` };
            } else {
                return { status: 'fresh', daysLeft: maxDays - daysInStorage, message: `Good for ${maxDays - daysInStorage} more days` };
            }
        }

        function updateStats() {
            const total = foodItems.length;
            const pantryCount = foodItems.filter(item => item.location === 'Pantry').length;
            const fridgeCount = foodItems.filter(item => item.location === 'Fridge').length;
            const freezerCount = foodItems.filter(item => item.location === 'Freezer').length;
            
            let expiringSoon = 0;
            foodItems.forEach(item => {
                const status = getItemStatus(item);
                if (status.status === 'warning' || status.status === 'expired') {
                    expiringSoon++;
                }
            });

            document.getElementById('totalItems').textContent = total;
            document.getElementById('pantryItems').textContent = pantryCount;
            document.getElementById('fridgeItems').textContent = fridgeCount;
            document.getElementById('freezerItems').textContent = freezerCount;
            document.getElementById('expiringSoon').textContent = expiringSoon;
        }

        function updateDisplay() {
            const grid = document.getElementById('itemsGrid');
            
            const itemsToShow = filterAndSortItems(foodItems);
            
            if (itemsToShow.length === 0) {
                let emptyMessage = 'No items found.';
                
                if (searchTerm) {
                    emptyMessage = `No items found matching "${searchTerm}".`;
                } else if (currentTab === 'all') {
                    emptyMessage = 'Your storage is empty! Add some items to get started.';
                } else {
                    emptyMessage = `Your ${currentTab} is empty! Add some items to get started.`;
                }
                
                grid.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
                updateStats();
                return;
            }

            grid.innerHTML = itemsToShow.map(item => {
                const status = getItemStatus(item);
                const daysInStorage = getDaysInStorage(item.storedDate);
                const locationClass = `location-${item.location.toLowerCase()}`;

                // Show who added the item (respect guest permissions)
                const showAddedBy = isGuestMode ?
                    (guestPermissions?.canViewDetails && item.addedByName) :
                    (item.addedByName && isAuthenticated);
                const addedByInfo = showAddedBy ? `<br>Added by: ${item.addedByName}` : '';

                // Show location based on guest permissions
                const showLocation = isGuestMode ? guestPermissions?.canViewLocation : true;
                const locationDisplay = showLocation ?
                    `<div class="storage-location ${locationClass}">${getLocationIcon(item.location)} ${item.location}</div>` :
                    '';

                // Show expiry information based on guest permissions
                const showExpiry = isGuestMode ? guestPermissions?.canViewExpiry : true;
                const expiryDisplay = showExpiry ?
                    `<div class="days-left ${status.status}">${status.message}</div>` :
                    `<div class="days-left">Expiration hidden</div>`;

                // Hide delete button for guests
                const deleteButton = isGuestMode ? '' : `<button class="delete-btn" onclick="deleteItem(${item.id})">Remove</button>`;

                // Format details based on permissions
                const locationText = showLocation ? (item.location === 'Freezer' ? 'Frozen' : 'Added') : 'Added';
                const locationDays = showLocation ? `<br>In ${item.location.toLowerCase()}: ${daysInStorage} days` : '';

                return `
                    <div class="item-card">
                        <div class="item-header">
                            <div>
                                <div class="item-name">${item.name}</div>
                                ${locationDisplay}
                                <div class="item-category">${item.category}</div>
                            </div>
                        </div>
                        <div class="item-details">
                            ${locationText}: ${item.storedDate.toLocaleDateString()}${locationDays}${addedByInfo}
                        </div>
                        ${expiryDisplay}
                        ${deleteButton}
                    </div>
                `;
            }).join('');

            updateStats();
        }

        function getLocationIcon(location) {
            switch(location) {
                case 'Pantry': return '🏠';
                case 'Fridge': return '❄️';
                case 'Freezer': return '🧊';
                default: return '📦';
            }
        }

        function lookupManualBarcode() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if (!barcode) {
                showLookupStatus('Please enter a barcode', 'error');
                return;
            }
            
            if (isBatchMode) {
                addToBatchQueue(barcode, 'Manual Entry');
                document.getElementById('manualBarcode').value = '';
            } else {
                lookupProduct(barcode);
                document.getElementById('manualBarcode').value = '';
            }
        }

        function addToBatchQueue(barcode, productName = null, category = null) {
            if (batchQueue.find(item => item.barcode === barcode)) {
                showLookupStatus('Item already in batch queue', 'error');
                return;
            }

            const batchItem = {
                id: Date.now(),
                barcode: barcode,
                name: productName || `Product ${barcode}`,
                category: category || 'Other',
                status: 'pending'
            };

            batchQueue.push(batchItem);
            updateBatchDisplay();
            
            if (!productName) {
                lookupProductForBatch(barcode, batchItem.id);
            }
        }

        function updateBatchDisplay() {
            const batchCount = document.getElementById('batchCount');
            const batchItems = document.getElementById('batchItems');
            
            batchCount.textContent = batchQueue.length;
            
            if (batchQueue.length === 0) {
                batchItems.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No items in queue</div>';
                return;
            }

            batchItems.innerHTML = batchQueue.map(item => `
                <div class="batch-item">
                    <div class="batch-item-info">
                        <div class="batch-item-name">${item.name}</div>
                        <div class="batch-item-details">${item.category} • ${item.barcode} ${item.status === 'loading' ? '(looking up...)' : ''}</div>
                    </div>
                    <button class="batch-remove" onclick="removeFromBatch(${item.id})">Remove</button>
                </div>
            `).join('');
        }

        function removeFromBatch(id) {
            batchQueue = batchQueue.filter(item => item.id !== id);
            updateBatchDisplay();
        }

        function clearBatchQueue() {
            batchQueue = [];
            updateBatchDisplay();
        }

        async function addAllBatchItems() {
            if (batchQueue.length === 0) {
                showLookupStatus('No items in batch queue', 'error');
                return;
            }

            const storedDateInput = document.getElementById('storedDate').value;
            const location = document.getElementById('storageLocation').value;

            let storedDate;
            if (storedDateInput) {
                const dateParts = storedDateInput.split('-');
                storedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            } else {
                storedDate = new Date();
            }

            showLookupStatus('Adding items to database...', 'loading');
            let addedCount = 0;

            try {
                // Add each item to Firestore
                for (const batchItem of batchQueue) {
                    const item = {
                        id: Date.now() + Math.random(),
                        name: batchItem.name,
                        category: batchItem.category,
                        location: location,
                        storedDate: storedDate,
                        addedDate: new Date()
                    };

                    await FirestoreService.saveFoodItem(item);

                    // If not using real-time listener, add to local array
                    if (!window.firestoreUnsubscribe) {
                        foodItems.push(item);
                    }

                    addedCount++;
                }

                clearBatchQueue();
                if (!window.firestoreUnsubscribe) {
                    updateDisplay();
                }
                showLookupStatus(`Added ${addedCount} items to ${location.toLowerCase()}!`, 'success');

                if (!isBatchMode) {
                    document.getElementById('batchQueue').style.display = 'none';
                }
            } catch (error) {
                console.error('Error adding batch items:', error);
                showLookupStatus('Error adding some items. Please try again.', 'error');
            }
        }

        async function lookupProductForBatch(barcode, batchId) {
            const batchItem = batchQueue.find(item => item.id === batchId);
            if (batchItem) {
                batchItem.status = 'loading';
                updateBatchDisplay();
            }

            try {
                const productInfo = await lookupProductInfo(barcode);
                
                const batchItemIndex = batchQueue.findIndex(item => item.id === batchId);
                if (batchItemIndex !== -1 && productInfo) {
                    batchQueue[batchItemIndex].name = productInfo.name;
                    batchQueue[batchItemIndex].category = productInfo.category;
                    batchQueue[batchItemIndex].status = 'found';
                } else if (batchItemIndex !== -1) {
                    batchQueue[batchItemIndex].status = 'not_found';
                }
                
                updateBatchDisplay();
            } catch (error) {
                const batchItemIndex = batchQueue.findIndex(item => item.id === batchId);
                if (batchItemIndex !== -1) {
                    batchQueue[batchItemIndex].status = 'error';
                    updateBatchDisplay();
                }
            }
        }

        function startScanner() {
            const scanBtn = document.getElementById('scanBtn');
            const batchBtn = document.getElementById('batchBtn');
            const scannerContainer = document.getElementById('scannerContainer');
            const scanMode = document.getElementById('scanMode');
            const video = document.getElementById('video');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showLookupStatus('Camera not supported on this device', 'error');
                return;
            }

            scanBtn.textContent = 'Starting camera...';
            scanBtn.disabled = true;
            batchBtn.disabled = true;
            scannerContainer.style.display = 'block';
            isScanning = true;

            scanMode.textContent = isBatchMode ? 'Batch Mode: Keep scanning items' : 'Single Mode: Will stop after first scan';
            
            if (isBatchMode) {
                document.getElementById('batchQueue').style.display = 'block';
            }

            navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "environment" }
            }).then(function(stream) {
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.play();
                
                showLookupStatus('Camera connected, starting barcode scanner...', 'loading');
                
                Quagga.init({
                    inputStream: {
                        name: "Live", type: "LiveStream", target: video,
                        constraints: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "environment" }
                    },
                    locator: { patchSize: "medium", halfSample: true },
                    numOfWorkers: 2, frequency: 10,
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader"],
                        debug: { drawBoundingBox: true, showFrequency: false, drawScanline: true, showPattern: false }
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.log('Quagga init error:', err);
                        showLookupStatus('Scanner initialization failed: ' + err.message, 'error');
                        
                        if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                        }
                        stopScanner();
                        return;
                    }
                    
                    scanBtn.textContent = isBatchMode ? '🛑 Stop Batch' : '🛑 Stop Scan';
                    batchBtn.textContent = isBatchMode ? '📦 Batch Mode' : '📦 Batch Scan';
                    showLookupStatus('Ready to scan! Point camera at barcode', 'success');
                    
                    Quagga.start();
                });

            }).catch(function(err) {
                console.log('Camera access error:', err);
                showLookupStatus('Camera access denied: ' + err.message, 'error');
                stopScanner();
            });

            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                const format = data.codeResult.format;
                
                console.log('Barcode detected:', code, 'Format:', format, 'Quality:', data.codeResult.quality);
                
                if (!isValidBarcode(code, format)) {
                    console.log('Invalid barcode detected, ignoring:', code);
                    return;
                }
                
                if (window.lastScannedCode === code && Date.now() - window.lastScanTime < 2000) {
                    return;
                }
                
                window.lastScannedCode = code;
                window.lastScanTime = Date.now();
                
                if (isBatchMode) {
                    addToBatchQueue(code);
                    showLookupStatus(`Scanned: ${code} (${format})`, 'success');
                } else {
                    stopScanner();
                    lookupProduct(code);
                }
            });
        }

        function stopScanner() {
            if (isScanning) {
                Quagga.stop();
                
                const video = document.getElementById('video');
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                
                isScanning = false;
                isBatchMode = false;
            }
            
            const scanBtn = document.getElementById('scanBtn');
            const batchBtn = document.getElementById('batchBtn');
            const scannerContainer = document.getElementById('scannerContainer');
            
            scanBtn.textContent = '📱 Scan Barcode';
            scanBtn.disabled = false;
            batchBtn.textContent = '📦 Batch Scan';
            batchBtn.disabled = false;
            scannerContainer.style.display = 'none';
        }

        async function lookupProduct(barcode) {
            showLookupStatus('Looking up product...', 'loading');
            
            const productInfo = await lookupProductInfo(barcode);
            
            if (productInfo) {
                document.getElementById('itemName').value = productInfo.name;
                document.getElementById('category').value = productInfo.category;
                showLookupStatus(`Found: ${productInfo.name}`, 'success');
            } else {
                document.getElementById('itemName').value = `Product ${barcode}`;
                showLookupStatus('Product not found in database, but barcode captured', 'error');
            }
        }

        async function lookupProductInfo(barcode) {
            try {
                let response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                let data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const productName = product.product_name || product.product_name_en || 'Unknown Product';
                    
                    let category = 'Other';
                    if (product.categories) {
                        category = guessCategory(product.categories.toLowerCase()) || 'Other';
                    }
                    
                    return { name: productName, category: category };
                }
                
                response = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${barcode}`);
                data = await response.json();
                
                if (data.code === 'OK' && data.items && data.items.length > 0) {
                    const item = data.items[0];
                    const productName = item.title || 'Unknown Product';
                    
                    let category = 'Other';
                    if (item.category) {
                        category = guessCategory(item.category.toLowerCase()) || 'Other';
                    }
                    
                    return { name: productName, category: category };
                }
                
                return null;
                
            } catch (error) {
                console.error('Lookup error:', error);
                return null;
            }
        }

        function guessCategory(text) {
            const categoryKeywords = {
                'Meat': ['meat', 'beef', 'chicken', 'pork', 'turkey', 'fish', 'salmon', 'tuna', 'bacon', 'sausage'],
                'Vegetables': ['vegetables', 'broccoli', 'spinach', 'carrots', 'peas', 'corn', 'beans', 'potato'],
                'Dairy': ['milk', 'cheese', 'yogurt', 'butter', 'cream', 'dairy'],
                'Grains': ['rice', 'pasta', 'bread', 'cereal', 'oats', 'quinoa', 'flour', 'wheat'],
                'Canned': ['canned', 'soup', 'sauce', 'tomato', 'beans'],
                'Snacks': ['chips', 'crackers', 'nuts', 'cookies', 'popcorn'],
                'Condiments': ['ketchup', 'mustard', 'mayo', 'dressing', 'oil', 'vinegar'],
                'Beverages': ['juice', 'soda', 'water', 'coffee', 'tea'],
                'Desserts': ['ice cream', 'frozen yogurt', 'dessert', 'cake', 'cookie', 'chocolate'],
                'Prepared': ['pizza', 'meal', 'dinner', 'lunch', 'prepared', 'frozen meal', 'burrito', 'sandwich']
            };
            
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return category;
                }
            }
            
            return null;
        }

        function isValidBarcode(code, format) {
            const cleanCode = code.replace(/\D/g, '');
            
            switch(format) {
                case 'ean_13':
                case 'ean_reader':
                    return cleanCode.length === 13 && /^\d{13}$/.test(cleanCode);
                case 'ean_8':
                    return cleanCode.length === 8 && /^\d{8}$/.test(cleanCode);
                case 'code_128':
                    return cleanCode.length >= 8 && cleanCode.length <= 14 && /^\d+$/.test(cleanCode);
                case 'code_39':
                    return code.length >= 3 && code.length <= 25;
                default:
                    return cleanCode.length >= 8 && /^\d+$/.test(cleanCode);
            }
        }

        function showLookupStatus(message, type) {
            const statusDiv = document.getElementById('lookupStatus');
            statusDiv.textContent = message;
            statusDiv.className = `lookup-${type}`;
            statusDiv.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('itemName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addItem();
                }
            });

            const manualBarcodeInput = document.getElementById('manualBarcode');
            if (manualBarcodeInput) {
                manualBarcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        lookupManualBarcode();
                    }
                });
            }

            updateDisplay();
        });

        function lookupManualBarcode() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if (!barcode) {
                showLookupStatus('Please enter a barcode', 'error');
                return;
            }
            
            if (isBatchMode) {
                addToBatchQueue(barcode, 'Manual Entry');
                document.getElementById('manualBarcode').value = '';
            } else {
                lookupProduct(barcode);
                document.getElementById('manualBarcode').value = '';
            }
        }

        function addToBatchQueue(barcode, productName = null, category = null) {
            // Check if already in queue
            if (batchQueue.find(item => item.barcode === barcode)) {
                showLookupStatus('Item already in batch queue', 'error');
                return;
            }

            const batchItem = {
                id: Date.now(),
                barcode: barcode,
                name: productName || `Product ${barcode}`,
                category: category || 'Other',
                status: 'pending'
            };

            batchQueue.push(batchItem);
            updateBatchDisplay();
            
            // If we don't have product info, try to look it up
            if (!productName) {
                lookupProductForBatch(barcode, batchItem.id);
            }
        }

        function updateBatchDisplay() {
            const batchCount = document.getElementById('batchCount');
            const batchItems = document.getElementById('batchItems');
            
            batchCount.textContent = batchQueue.length;
            
            if (batchQueue.length === 0) {
                batchItems.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No items in queue</div>';
                return;
            }

            batchItems.innerHTML = batchQueue.map(item => `
                <div class="batch-item">
                    <div class="batch-item-info">
                        <div class="batch-item-name">${item.name}</div>
                        <div class="batch-item-details">${item.category} • ${item.barcode} ${item.status === 'loading' ? '(looking up...)' : ''}</div>
                    </div>
                    <button class="batch-remove" onclick="removeFromBatch(${item.id})">Remove</button>
                </div>
            `).join('');
        }

        function removeFromBatch(id) {
            batchQueue = batchQueue.filter(item => item.id !== id);
            updateBatchDisplay();
        }

        function clearBatchQueue() {
            batchQueue = [];
            updateBatchDisplay();
        }

        function addAllBatchItems() {
            if (batchQueue.length === 0) {
                showLookupStatus('No items in batch queue', 'error');
                return;
            }

            // Get values from form
            const storedDateInput = document.getElementById('storedDate').value;
            const location = document.getElementById('storageLocation').value;
            
            let storedDate;
            
            if (storedDateInput) {
                // Fix timezone issue by creating date in local timezone
                const dateParts = storedDateInput.split('-');
                storedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            } else {
                storedDate = new Date();
            }

            let addedCount = 0;

            batchQueue.forEach(batchItem => {
                const item = {
                    id: Date.now() + Math.random(), // Ensure unique IDs
                    name: batchItem.name,
                    category: batchItem.category,
                    location: location,
                    storedDate: storedDate,
                    addedDate: new Date()
                };
                
                foodItems.push(item);
                addedCount++;
            });

            clearBatchQueue();
            updateDisplay();
            showLookupStatus(`Added ${addedCount} items to ${location.toLowerCase()}!`, 'success');
            
            // Hide batch queue if not in batch mode
            if (!isBatchMode) {
                document.getElementById('batchQueue').style.display = 'none';
            }
        }

        async function lookupProductForBatch(barcode, batchId) {
            // Update status to loading
            const batchItem = batchQueue.find(item => item.id === batchId);
            if (batchItem) {
                batchItem.status = 'loading';
                updateBatchDisplay();
            }

            try {
                const productInfo = await lookupProductInfo(barcode);
                
                const batchItemIndex = batchQueue.findIndex(item => item.id === batchId);
                if (batchItemIndex !== -1 && productInfo) {
                    batchQueue[batchItemIndex].name = productInfo.name;
                    batchQueue[batchItemIndex].category = productInfo.category;
                    batchQueue[batchItemIndex].status = 'found';
                } else if (batchItemIndex !== -1) {
                    batchQueue[batchItemIndex].status = 'not_found';
                }
                
                updateBatchDisplay();
            } catch (error) {
                const batchItemIndex = batchQueue.findIndex(item => item.id === batchId);
                if (batchItemIndex !== -1) {
                    batchQueue[batchItemIndex].status = 'error';
                    updateBatchDisplay();
                }
            }
        }

        function startScanner() {
            const scanBtn = document.getElementById('scanBtn');
            const batchBtn = document.getElementById('batchBtn');
            const scannerContainer = document.getElementById('scannerContainer');
            const scanMode = document.getElementById('scanMode');
            const video = document.getElementById('video');
            
            // Check if camera is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showLookupStatus('Camera not supported on this device', 'error');
                return;
            }

            scanBtn.textContent = 'Starting camera...';
            scanBtn.disabled = true;
            batchBtn.disabled = true;
            scannerContainer.style.display = 'block';
            isScanning = true;

            // Show current mode
            scanMode.textContent = isBatchMode ? 'Batch Mode: Keep scanning items' : 'Single Mode: Will stop after first scan';
            
            if (isBatchMode) {
                document.getElementById('batchQueue').style.display = 'block';
            }

            // First get camera access directly
            navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: "environment"
                }
            }).then(function(stream) {
                // Set the video source to the camera stream
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.play();
                
                showLookupStatus('Camera connected, starting barcode scanner...', 'loading');
                
                // Now initialize Quagga with the video element
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10,
                    decoder: {
                        readers: [
                            "ean_reader",
                            "ean_8_reader", 
                            "code_128_reader",
                            "code_39_reader"
                        ],
                        debug: {
                            drawBoundingBox: true,
                            showFrequency: false,
                            drawScanline: true,
                            showPattern: false
                        }
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.log('Quagga init error:', err);
                        showLookupStatus('Scanner initialization failed: ' + err.message, 'error');
                        
                        // Stop the video stream
                        if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                        }
                        stopScanner();
                        return;
                    }
                    
                    scanBtn.textContent = isBatchMode ? '🛑 Stop Batch' : '🛑 Stop Scan';
                    batchBtn.textContent = isBatchMode ? '📦 Batch Mode' : '📦 Batch Scan';
                    showLookupStatus('Ready to scan! Point camera at barcode', 'success');
                    
                    Quagga.start();
                });

            }).catch(function(err) {
                console.log('Camera access error:', err);
                showLookupStatus('Camera access denied: ' + err.message, 'error');
                stopScanner();
            });

            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                const format = data.codeResult.format;
                
                console.log('Barcode detected:', code, 'Format:', format, 'Quality:', data.codeResult.quality);
                
                // Validate barcode format and length
                if (!isValidBarcode(code, format)) {
                    console.log('Invalid barcode detected, ignoring:', code);
                    return;
                }
                
                // Add a brief delay to prevent multiple rapid scans of the same code
                if (window.lastScannedCode === code && Date.now() - window.lastScanTime < 2000) {
                    return;
                }
                
                window.lastScannedCode = code;
                window.lastScanTime = Date.now();
                
                if (isBatchMode) {
                    // In batch mode, add to queue and keep scanning
                    addToBatchQueue(code);
                    showLookupStatus(`Scanned: ${code} (${format})`, 'success');
                } else {
                    // In single mode, stop scanning and look up
                    stopScanner();
                    lookupProduct(code);
                }
            });
        }

        function stopScanner() {
            if (isScanning) {
                Quagga.stop();
                
                // Stop all video tracks
                const video = document.getElementById('video');
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                
                isScanning = false;
                isBatchMode = false;
            }
            
            const scanBtn = document.getElementById('scanBtn');
            const batchBtn = document.getElementById('batchBtn');
            const scannerContainer = document.getElementById('scannerContainer');
            
            scanBtn.textContent = '📱 Scan Barcode';
            scanBtn.disabled = false;
            batchBtn.textContent = '📦 Batch Scan';
            batchBtn.disabled = false;
            scannerContainer.style.display = 'none';
        }

        async function lookupProduct(barcode) {
            showLookupStatus('Looking up product...', 'loading');
            
            const productInfo = await lookupProductInfo(barcode);
            
            if (productInfo) {
                // Auto-fill the form
                document.getElementById('itemName').value = productInfo.name;
                document.getElementById('category').value = productInfo.category;
                showLookupStatus(`Found: ${productInfo.name}`, 'success');
            } else {
                // If lookup fails, just fill in the barcode
                document.getElementById('itemName').value = `Product ${barcode}`;
                showLookupStatus('Product not found in database, but barcode captured', 'error');
            }
        }

        async function lookupProductInfo(barcode) {
            try {
                // Try OpenFoodFacts API first
                let response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                let data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const productName = product.product_name || product.product_name_en || 'Unknown Product';
                    
                    // Try to guess category based on categories
                    let category = 'Other';
                    if (product.categories) {
                        category = guessCategory(product.categories.toLowerCase()) || 'Other';
                    }
                    
                    return { name: productName, category: category };
                }
                
                // If OpenFoodFacts fails, try UPC Database
                response = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${barcode}`);
                data = await response.json();
                
                if (data.code === 'OK' && data.items && data.items.length > 0) {
                    const item = data.items[0];
                    const productName = item.title || 'Unknown Product';
                    
                    // Try to guess category from title
                    let category = 'Other';
                    if (item.category) {
                        category = guessCategory(item.category.toLowerCase()) || 'Other';
                    }
                    
                    return { name: productName, category: category };
                }
                
                return null;
                
            } catch (error) {
                console.error('Lookup error:', error);
                return null;
            }
        }

        function guessCategory(text) {
            const categoryKeywords = {
                'Meat': ['meat', 'beef', 'chicken', 'pork', 'turkey', 'fish', 'salmon', 'tuna', 'bacon', 'sausage'],
                'Vegetables': ['vegetables', 'broccoli', 'spinach', 'carrots', 'peas', 'corn', 'beans', 'potato'],
                'Dairy': ['milk', 'cheese', 'yogurt', 'butter', 'cream', 'dairy'],
                'Grains': ['rice', 'pasta', 'bread', 'cereal', 'oats', 'quinoa', 'flour', 'wheat'],
                'Canned': ['canned', 'soup', 'sauce', 'tomato', 'beans'],
                'Snacks': ['chips', 'crackers', 'nuts', 'cookies', 'popcorn'],
                'Condiments': ['ketchup', 'mustard', 'mayo', 'dressing', 'oil', 'vinegar'],
                'Beverages': ['juice', 'soda', 'water', 'coffee', 'tea'],
                'Desserts': ['ice cream', 'frozen yogurt', 'dessert', 'cake', 'cookie', 'chocolate'],
                'Prepared': ['pizza', 'meal', 'dinner', 'lunch', 'prepared', 'frozen meal', 'burrito', 'sandwich']
            };
            
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return category;
                }
            }
            
            return null;
        }

        function isValidBarcode(code, format) {
            // Remove any non-digit characters for validation
            const cleanCode = code.replace(/\D/g, '');
            
            switch(format) {
                case 'ean_13':
                case 'ean_reader':
                    return cleanCode.length === 13 && /^\d{13}$/.test(cleanCode);
                case 'ean_8':
                    return cleanCode.length === 8 && /^\d{8}$/.test(cleanCode);
                case 'code_128':
                    // UPC-A codes are often read as Code 128
                    return cleanCode.length >= 8 && cleanCode.length <= 14 && /^\d+$/.test(cleanCode);
                case 'code_39':
                    return code.length >= 3 && code.length <= 25;
                default:
                    // For unknown formats, require at least 8 digits
                    return cleanCode.length >= 8 && /^\d+$/.test(cleanCode);
            }
        }

        function showLookupStatus(message, type) {
            const statusDiv = document.getElementById('lookupStatus');
            statusDiv.textContent = message;
            statusDiv.className = `lookup-${type}`;
            statusDiv.style.display = 'block';
            
            // Hide after 5 seconds unless it's an error
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Handle Enter key in item name input
        document.getElementById('itemName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addItem();
            }
        });

        // Handle Enter key in manual barcode input - wait for DOM
        document.addEventListener('DOMContentLoaded', function() {
            const manualBarcodeInput = document.getElementById('manualBarcode');
            if (manualBarcodeInput) {
                manualBarcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        lookupManualBarcode();
                    }
                });
            }
        });

        // Initial display update
        updateDisplay();
    </script>
</body>
</html>
