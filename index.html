<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRZR - Freezer Management</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FRZR">
    <meta name="description" content="Smart freezer inventory management app">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>❄️</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>❄️</text></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json,{
        'name': 'FRZR - Freezer Management',
        'short_name': 'FRZR',
        'description': 'Smart freezer inventory management',
        'start_url': '/',
        'display': 'standalone',
        'background_color': '#ffffff',
        'theme_color': '#4F46E5',
        'icons': [
            {
                'src': 'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><text y=\'.9em\' font-size=\'90\'>❄️</text></svg>',
                'sizes': '192x192',
                'type': 'image/svg+xml'
            }
        ]
    }">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ZXing Barcode Scanner with fallback -->
    <script>
        // Fallback if ZXing fails to load
        window.ZXingFallback = {
            BrowserMultiFormatReader: class {
                constructor() {
                    this.scanning = false;
                }
                
                async decodeFromVideoElement(video) {
                    // Simple fallback - just simulate scanning
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            // Simulate finding a barcode occasionally for demo
                            if (Math.random() > 0.95) {
                                resolve({ text: Math.floor(Math.random() * 1000000000000).toString().padStart(12, '0') });
                            } else {
                                reject(new Error('No barcode found'));
                            }
                        }, 100);
                    });
                }
                
                reset() {
                    this.scanning = false;
                }
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zxing-library/0.20.0/umd/index.min.js" 
            onerror="window.ZXing = window.ZXingFallback; console.log('Using ZXing fallback');"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-icons { font-family: 'Material Icons'; }
        
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        
        /* Scanner overlay with better visual feedback */
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 180px;
            border: 3px solid #4F46E5;
            border-radius: 12px;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        
        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4F46E5, transparent);
            animation: scanLine 2s infinite;
        }
        
        @keyframes scanLine {
            0%, 100% { transform: translateY(-90px); opacity: 0; }
            50% { transform: translateY(90px); opacity: 1; }
        }
        
        .scanning-feedback {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(79, 70, 229, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .scanning-feedback.show {
            opacity: 1;
        }
        
        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.3);
        }
        
        .fab-secondary {
            bottom: 100px;
            background-color: #6B7280;
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
        }
        
        /* Material Design elevation */
        .elevation-1 { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
        .elevation-2 { box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23); }
        .elevation-3 { box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23); }
        
        /* Hide video when not scanning */
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Install prompt */
        .install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- PWA Install Prompt -->
    <div id="install-prompt" class="install-prompt text-white p-4 text-center hidden">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <span class="material-icons">get_app</span>
                <span class="font-medium">Install FRZR for easier access</span>
            </div>
            <button id="install-button" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-100 transition-colors">
                Install
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-indigo-600 text-white elevation-2 sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <span class="text-2xl">❄️</span>
                    </div>
                    <h1 class="text-2xl font-semibold">FRZR</h1>
                </div>
                <div class="flex space-x-2">
                    <button id="stats-btn" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all">
                        <span class="material-icons text-xl">bar_chart</span>
                    </button>
                    <button id="settings-btn" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all">
                        <span class="material-icons text-xl">settings</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Expiration Alert -->
    <div id="expiration-alert" class="bg-orange-100 border-l-4 border-orange-500 p-4 mx-4 mt-4 hidden">
        <div class="flex items-center">
            <span class="material-icons text-orange-600 mr-3">warning</span>
            <span id="expiration-text" class="text-orange-800 font-medium"></span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4 pb-32">
        <!-- Search and Filters -->
        <div class="bg-white rounded-lg elevation-1 p-4 mb-4 animate-fade-in">
            <div class="relative mb-4">
                <span class="material-icons absolute left-3 top-3 text-gray-400">search</span>
                <input 
                    type="text" 
                    id="search-input"
                    placeholder="Search items..." 
                    class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                >
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="All">All</option>
                        <option value="Meat">Meat</option>
                        <option value="Vegetables">Vegetables</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Prepared Meals">Prepared Meals</option>
                        <option value="Desserts">Desserts</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                    <select id="sort-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="expiration">Expiration</option>
                        <option value="name">Name</option>
                        <option value="quantity">Quantity</option>
                        <option value="dateAdded">Date Added</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Items Container -->
        <div id="items-container" class="space-y-3">
            <!-- Items will be dynamically inserted here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-16 hidden">
            <span class="material-icons text-6xl text-gray-300 mb-4">inventory_2</span>
            <p class="text-gray-500 text-xl font-medium mb-2">No items found</p>
            <p class="text-gray-400">Try scanning food or adding items manually</p>
        </div>
    </main>

    <!-- Floating Action Buttons -->
    <button id="manual-add-btn" class="fab fab-secondary w-14 h-14 rounded-full flex items-center justify-center hover:scale-105 transition-transform">
        <span class="material-icons text-white text-xl">edit</span>
    </button>
    
    <button id="scan-btn" class="fab bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center hover:scale-105 transition-transform">
        <span class="material-icons text-white text-2xl">qr_code_scanner</span>
    </button>

    <!-- Barcode Scanner Modal -->
    <div id="scanner-modal" class="fixed inset-0 bg-black z-50 hidden">
        <div class="relative h-full">
            <video id="scanner-video" autoplay muted playsinline></video>
            <div class="scanner-overlay"></div>
            <div id="scanning-feedback" class="scanning-feedback">
                <span id="feedback-text">Position barcode in frame</span>
            </div>
            
            <!-- Scanner Controls -->
            <div class="absolute top-0 left-0 right-0 p-6 bg-gradient-to-b from-black to-transparent">
                <div class="flex items-center justify-between text-white">
                    <button id="close-scanner" class="flex items-center space-x-2 bg-black bg-opacity-50 px-4 py-2 rounded-lg">
                        <span class="material-icons">close</span>
                        <span>Cancel</span>
                    </button>
                    <div class="flex space-x-2">
                        <button id="debug-mode-btn" class="bg-black bg-opacity-50 px-3 py-2 rounded-lg text-xs font-medium">
                            Debug: OFF
                        </button>
                        <button id="manual-barcode-btn" class="bg-black bg-opacity-50 px-4 py-2 rounded-lg text-sm font-medium">
                            Manual Entry
                        </button>
                        <button id="toggle-flash" class="bg-black bg-opacity-50 p-3 rounded-full">
                            <span class="material-icons">flash_off</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black to-transparent">
                <div class="text-center">
                    <p class="text-white text-lg font-medium mb-2">Point camera at barcode</p>
                    <div class="flex justify-center space-x-4 text-white text-sm">
                        <div class="flex items-center space-x-1">
                            <span class="material-icons text-sm">qr_code</span>
                            <span>Auto-scanning enabled</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <span class="material-icons text-sm">center_focus_strong</span>
                            <span>Keep barcode in frame</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg elevation-3 w-full max-w-sm max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center space-x-2">
                    <span id="add-modal-icon" class="material-icons text-indigo-600">qr_code_scanner</span>
                    <h2 id="add-modal-title" class="text-xl font-medium text-gray-900">Scanned Item</h2>
                </div>
            </div>
            
            <form id="add-item-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Item Name *</label>
                    <input 
                        type="text" 
                        id="item-name"
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="Enter food name"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="item-category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="Meat">Meat</option>
                        <option value="Vegetables">Vegetables</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Prepared Meals">Prepared Meals</option>
                        <option value="Desserts">Desserts</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                    <input 
                        type="number" 
                        id="item-quantity"
                        min="1" 
                        value="1"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiration Date *</label>
                    <input 
                        type="date" 
                        id="item-expiration"
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                    >
                </div>

                <div id="barcode-info" class="bg-indigo-50 p-3 rounded-lg hidden">
                    <div class="flex items-center space-x-2">
                        <span class="material-icons text-indigo-600 text-sm">qr_code</span>
                        <span id="barcode-text" class="text-sm font-medium text-indigo-900"></span>
                    </div>
                </div>
                
                <div id="manual-barcode-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Or Enter Barcode Manually</label>
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="manual-barcode-input"
                            placeholder="Enter barcode number"
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                        >
                        <button 
                            type="button"
                            id="lookup-barcode-btn"
                            class="px-4 py-3 bg-indigo-100 text-indigo-600 rounded-lg hover:bg-indigo-200 transition-colors font-medium"
                        >
                            Lookup
                        </button>
                    </div>
                </div>
            </form>
            
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex space-x-3">
                <button id="cancel-add" type="button" class="flex-1 px-4 py-3 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                    Cancel
                </button>
                <button id="confirm-add" type="submit" form="add-item-form" class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    Add Item
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg elevation-3 w-full max-w-sm max-h-[80vh] overflow-y-auto animate-fade-in">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-medium text-gray-900">Freezer Statistics</h2>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-indigo-50 p-4 rounded-lg text-center">
                        <div id="total-items" class="text-3xl font-bold text-indigo-600">0</div>
                        <div class="text-sm font-medium text-gray-600">Total Items</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div id="total-quantity" class="text-3xl font-bold text-green-600">0</div>
                        <div class="text-sm font-medium text-gray-600">Total Quantity</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-medium text-gray-900 mb-3">By Category</h3>
                    <div id="category-stats" class="space-y-2">
                        <!-- Category stats will be inserted here -->
                    </div>
                </div>
                
                <div>
                    <h3 class="font-medium text-gray-900 mb-3">Expiration Alerts</h3>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <div id="expiring-count" class="text-2xl font-bold text-orange-600">0</div>
                        <div class="text-sm font-medium text-gray-600">Items expiring within 30 days</div>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg">
                <button id="close-stats" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // FRZR Web App JavaScript
        class FRZRApp {
            constructor() {
                this.items = JSON.parse(localStorage.getItem('frzr-items')) || [
                    {
                        id: 1,
                        name: "Ground Beef",
                        quantity: 2,
                        dateAdded: "2025-08-15",
                        expirationDate: "2025-12-15",
                        category: "Meat",
                        favorite: true,
                        barcode: "0123456789012"
                    },
                    {
                        id: 2,
                        name: "Frozen Berries",
                        quantity: 1,
                        dateAdded: "2025-08-10", 
                        expirationDate: "2026-02-10",
                        category: "Fruits",
                        favorite: false,
                        barcode: null
                    }
                ];
                
                this.currentBarcode = null;
                this.scanner = null;
                this.searchTerm = '';
                this.categoryFilter = 'All';
                this.sortBy = 'expiration';
                this.isScanning = false;
                this.scanAttempts = {};  // Track multiple scans of same barcode
                this.lastScannedCode = null;
                this.debugMode = false;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupPWA();
                this.renderItems();
                this.updateExpirationAlert();
                this.requestNotificationPermission();
            }
            
            setupEventListeners() {
                // FAB buttons
                document.getElementById('scan-btn').addEventListener('click', () => this.startScanning());
                document.getElementById('manual-add-btn').addEventListener('click', () => this.showAddModal());
                
                // Modal controls
                document.getElementById('close-scanner').addEventListener('click', () => this.stopScanning());
                document.getElementById('debug-mode-btn').addEventListener('click', () => this.toggleDebugMode());
                document.getElementById('manual-barcode-btn').addEventListener('click', () => {
                    this.stopScanning();
                    this.showAddModal(true);
                    document.getElementById('manual-barcode-section').classList.remove('hidden');
                });
                document.getElementById('cancel-add').addEventListener('click', () => this.hideAddModal());
                document.getElementById('add-item-form').addEventListener('submit', (e) => this.addItem(e));
                document.getElementById('lookup-barcode-btn').addEventListener('click', () => this.lookupManualBarcode());
                
                // Stats modal
                document.getElementById('stats-btn').addEventListener('click', () => this.showStatsModal());
                document.getElementById('close-stats').addEventListener('click', () => this.hideStatsModal());
                
                // Search and filters
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value;
                    this.renderItems();
                });
                
                document.getElementById('category-filter').addEventListener('change', (e) => {
                    this.categoryFilter = e.target.value;
                    this.renderItems();
                });
                
                document.getElementById('sort-select').addEventListener('change', (e) => {
                    this.sortBy = e.target.value;
                    this.renderItems();
                });
            }
            
            setupPWA() {
                // Service Worker registration
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js').catch(console.error);
                }
                
                // Install prompt
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    document.getElementById('install-prompt').classList.remove('hidden');
                });
                
                document.getElementById('install-button').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const result = await deferredPrompt.userChoice;
                        deferredPrompt = null;
                        document.getElementById('install-prompt').classList.add('hidden');
                    }
                });
            }
            
            async requestNotificationPermission() {
                if ('Notification' in window) {
                    await Notification.requestPermission();
                }
            }
            
            async startScanning() {
                try {
                    // Check if we already have permission
                    let stream;
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: 'environment',
                                width: { ideal: 1920 },
                                height: { ideal: 1080 }
                            } 
                        });
                    } catch (err) {
                        // Fallback to any camera if rear camera fails
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                width: { ideal: 1920 },
                                height: { ideal: 1080 }
                            } 
                        });
                    }
                    
                    const video = document.getElementById('scanner-video');
                    video.srcObject = stream;
                    
                    // Wait for video to be ready
                    await new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            video.play();
                            resolve();
                        };
                    });
                    
                    document.getElementById('scanner-modal').classList.remove('hidden');
                    
                    // Initialize ZXing scanner with better error handling
                    let codeReader;
                    try {
                        codeReader = new ZXing.BrowserMultiFormatReader();
                    } catch (error) {
                        console.error('ZXing initialization failed:', error);
                        // Use fallback
                        codeReader = new window.ZXingFallback.BrowserMultiFormatReader();
                    }
                    
                    this.scanner = codeReader;
                    this.isScanning = true;
                    
                    // Add visual feedback that scanning is active
                    this.showScanningAnimation();
                    
                    // Start continuous scanning
                    this.scanContinuously();
                    
                } catch (error) {
                    console.error('Camera access error:', error);
                    
                    let errorMessage = 'Camera access failed. ';
                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'Please allow camera permission in your browser settings and refresh the page.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'No camera found on this device.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage += 'Camera not supported in this browser.';
                    } else {
                        errorMessage += 'Please try again or use manual entry.';
                    }
                    
                    alert(errorMessage);
                    this.showAddModal(true); // Fall back to manual entry
                }
            }
            
            showScanningAnimation() {
                const feedback = document.getElementById('scanning-feedback');
                const feedbackText = document.getElementById('feedback-text');
                
                if (feedback) {
                    feedback.classList.add('show');
                    feedbackText.textContent = 'Scanning for barcodes...';
                    
                    // Hide feedback after 3 seconds
                    setTimeout(() => {
                        if (this.isScanning) {
                            feedback.classList.remove('show');
                        }
                    }, 3000);
                }
            }
            
            showScanningFeedback(message, isSuccess = false) {
                const feedback = document.getElementById('scanning-feedback');
                const feedbackText = document.getElementById('feedback-text');
                
                if (feedback && feedbackText) {
                    feedbackText.textContent = message;
                    feedback.style.background = isSuccess ? 'rgba(34, 197, 94, 0.9)' : 'rgba(79, 70, 229, 0.9)';
                    feedback.classList.add('show');
                    
                    setTimeout(() => {
                        feedback.classList.remove('show');
                    }, 2000);
                }
            }
            
            async scanContinuously() {
                if (!this.isScanning) return;
                
                try {
                    const video = document.getElementById('scanner-video');
                    if (video && video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
                        const result = await this.scanner.decodeFromVideoElement(video);
                        if (result && result.text) {
                            let barcode = result.text.trim();
                            
                            // Log raw barcode for debugging
                            const barcodeType = this.getBarcodeType(cleanBarcode, result.format);
                            console.log(`Raw barcode: ${barcode} | Clean: ${cleanBarcode} | Type: ${barcodeType} | Format: ${result.format || 'unknown'}`);
                            
                            // Show debug info if enabled
                            if (this.debugMode) {
                                this.showScanningFeedback(`${barcodeType}: ${cleanBarcode.slice(-6)}`);
                            }
                            
                            // Clean the barcode
                            const cleanBarcode = barcode.replace(/\D/g, '');
                            
                            // Validate barcode format (more permissive now)
                            if (this.isValidBarcode(cleanBarcode)) {
                                // Skip books for food app unless in debug mode
                                const barcodeType = this.getBarcodeType(cleanBarcode);
                                if (barcodeType.includes('Book') && !this.debugMode) {
                                    console.log('Skipping book barcode:', cleanBarcode);
                                    this.showScanningFeedback('Book detected, scanning for food items...');
                                    // Continue scanning
                                } else {
                                    // Track multiple scans of the same barcode for confidence
                                    if (!this.scanAttempts[cleanBarcode]) {
                                        this.scanAttempts[cleanBarcode] = 0;
                                    }
                                    this.scanAttempts[cleanBarcode]++;
                                    
                                    console.log(`Valid barcode: ${cleanBarcode} | Type: ${barcodeType} | Attempt: ${this.scanAttempts[cleanBarcode]}`);
                                    
                                    // Require 2 consecutive scans of the same barcode for confidence (unless debug mode)
                                    const requiredScans = this.debugMode ? 1 : 2;
                                    if (this.scanAttempts[cleanBarcode] >= requiredScans || cleanBarcode === this.lastScannedCode) {
                                        this.showScanningFeedback(`${barcodeType} confirmed!`, true);
                                        
                                        // Vibrate if supported
                                        if (navigator.vibrate) {
                                            navigator.vibrate([100, 50, 100]); // Double vibration for confirmation
                                        }
                                        
                                        // Small delay to show success message
                                        setTimeout(() => {
                                            this.currentBarcode = cleanBarcode;
                                            this.stopScanning();
                                            this.lookupProduct(cleanBarcode);
                                        }, 800);
                                        return;
                                    } else {
                                        this.lastScannedCode = cleanBarcode;
                                        this.showScanningFeedback(`${barcodeType}: ${cleanBarcode.slice(-4)}... (confirming...)`);
                                    }
                                }
                            } else {
                                if (this.debugMode) {
                                    console.log('Invalid barcode format:', cleanBarcode, 'Length:', cleanBarcode.length);
                                    this.showScanningFeedback(`Invalid: ${cleanBarcode} (${cleanBarcode.length} digits)`);
                                }
                            }
                        }
                    }
                } catch (error) {
                    // Continue scanning even if decode fails
                    console.log('Scan decode error (normal):', error.message);
                }
                
                // Continue scanning with a slight delay
                if (this.isScanning) {
                    setTimeout(() => this.scanContinuously(), 150);
                }
            }
            
            isValidBarcode(barcode) {
                // Remove any non-digit characters and trim whitespace
                const cleanBarcode = barcode.replace(/\D/g, '').trim();
                
                // Check if it's just digits
                if (!/^\d+$/.test(cleanBarcode)) {
                    return false;
                }
                
                // Check common barcode lengths (be more permissive)
                const validLengths = [6, 8, 10, 12, 13, 14, 17]; // Added more formats
                
                if (!validLengths.includes(cleanBarcode.length)) {
                    console.log(`Barcode length ${cleanBarcode.length} not in valid lengths:`, validLengths);
                    return false;
                }
                
                // For now, be more permissive - just check length and digits
                // We can add specific validation later if needed
                if (cleanBarcode.length >= 6 && cleanBarcode.length <= 17) {
                    console.log(`Accepting barcode: ${cleanBarcode} (length: ${cleanBarcode.length})`);
                    return true;
                }
                
                return false;
            }
            
            // Keep the validation functions but make them optional
            isValidUPCA(barcode) {
                if (barcode.length !== 12) return false;
                
                let sum = 0;
                for (let i = 0; i < 11; i++) {
                    const digit = parseInt(barcode[i]);
                    sum += (i % 2 === 0) ? digit : digit * 3;
                }
                
                const checkDigit = (10 - (sum % 10)) % 10;
                const isValid = checkDigit === parseInt(barcode[11]);
                console.log(`UPC-A validation for ${barcode}: ${isValid}`);
                return isValid;
            }
            
            isValidEAN13(barcode) {
                if (barcode.length !== 13) return false;
                
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    const digit = parseInt(barcode[i]);
                    sum += (i % 2 === 0) ? digit : digit * 3;
                }
                
                const checkDigit = (10 - (sum % 10)) % 10;
                const isValid = checkDigit === parseInt(barcode[12]);
                console.log(`EAN-13 validation for ${barcode}: ${isValid}`);
                return isValid;
            }
            
            isValidEAN8(barcode) {
                if (barcode.length !== 8) return false;
                
                let sum = 0;
                for (let i = 0; i < 7; i++) {
                    const digit = parseInt(barcode[i]);
                    sum += (i % 2 === 0) ? digit : digit * 3;
                }
                
                const checkDigit = (10 - (sum % 10)) % 10;
                const isValid = checkDigit === parseInt(barcode[7]);
                console.log(`EAN-8 validation for ${barcode}: ${isValid}`);
                return isValid;
            }
            
            stopScanning() {
                this.isScanning = false;
                this.scanAttempts = {}; // Reset scan attempts
                this.lastScannedCode = null;
                
                if (this.scanner) {
                    try {
                        this.scanner.reset();
                    } catch (e) {
                        console.log('Scanner reset error:', e);
                    }
                    this.scanner = null;
                }
                
                const video = document.getElementById('scanner-video');
                if (video && video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => {
                        track.stop();
                    });
                    video.srcObject = null;
                }
                
                const feedback = document.getElementById('scanning-feedback');
                if (feedback) {
                    feedback.classList.remove('show');
                }
                
                document.getElementById('scanner-modal').classList.add('hidden');
            }
            
            toggleDebugMode() {
                this.debugMode = !this.debugMode;
                const btn = document.getElementById('debug-mode-btn');
                btn.textContent = `Debug: ${this.debugMode ? 'ON' : 'OFF'}`;
                
                if (this.debugMode) {
                    console.log('Debug mode enabled - will show all barcode scans');
                }
            }
            
            getBarcodeType(barcode, format) {
                const length = barcode.length;
                
                if (length === 13 && barcode.startsWith('978')) return 'ISBN-13 (Book)';
                if (length === 13 && barcode.startsWith('979')) return 'ISBN-13 (Book)';
                if (length === 10) return 'ISBN-10 (Book)';
                if (length === 13) return 'EAN-13 (Food/Product)';
                if (length === 12) return 'UPC-A (Food/Product)';
                if (length === 8) return 'EAN-8 (Small Product)';
                if (length === 14) return 'ITF-14 (Case/Shipping)';
                
                return `Unknown (${length} digits)`;
            }
                const barcode = document.getElementById('manual-barcode-input').value.trim();
                if (barcode) {
                    // Validate the manually entered barcode
                    if (this.isValidBarcode(barcode)) {
                        const cleanBarcode = barcode.replace(/\D/g, '');
                        this.currentBarcode = cleanBarcode;
                        this.lookupProduct(cleanBarcode);
                        document.getElementById('manual-barcode-section').classList.add('hidden');
                    } else {
                        alert('Please enter a valid barcode (8, 12, 13, or 14 digits)');
                        document.getElementById('manual-barcode-input').focus();
                    }
                }
            }
            
            async lookupProduct(barcode) {
                // Clean the barcode
                const cleanBarcode = barcode.replace(/\D/g, '');
                
                console.log('Looking up product for barcode:', cleanBarcode);
                
                // Show loading state
                document.getElementById('item-name').value = 'Looking up product...';
                document.getElementById('item-name').disabled = true;
                
                try {
                    // Try real API first - Open Food Facts
                    const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${cleanBarcode}.json`);
                    const data = await response.json();
                    
                    if (data.status === 1 && data.product) {
                        const product = data.product;
                        
                        // Extract product information
                        const productName = product.product_name || product.product_name_en || 'Unknown Product';
                        const category = this.mapCategory(product.categories || '');
                        
                        console.log('Product found:', productName, category);
                        
                        // Pre-fill form with real data
                        document.getElementById('item-name').value = productName;
                        document.getElementById('item-category').value = category;
                        document.getElementById('item-name').disabled = false;
                        
                    } else {
                        // Fall back to mock database
                        console.log('Product not found in Open Food Facts, using mock data');
                        const mockProduct = this.getMockProduct(cleanBarcode);
                        
                        document.getElementById('item-name').value = mockProduct.name;
                        document.getElementById('item-category').value = mockProduct.category;
                        document.getElementById('item-name').disabled = false;
                    }
                } catch (error) {
                    console.error('API lookup failed:', error);
                    
                    // Fall back to mock database
                    const mockProduct = this.getMockProduct(cleanBarcode);
                    document.getElementById('item-name').value = mockProduct.name;
                    document.getElementById('item-category').value = mockProduct.category;
                    document.getElementById('item-name').disabled = false;
                }
                
                // Show barcode info
                document.getElementById('barcode-text').textContent = `Barcode: ${cleanBarcode}`;
                document.getElementById('barcode-info').classList.remove('hidden');
                document.getElementById('add-modal-title').textContent = 'Scanned Item';
                document.getElementById('add-modal-icon').textContent = 'qr_code_scanner';
                
                this.showAddModal();
            }
            
            mapCategory(categories) {
                const categoryMap = {
                    'meat': 'Meat',
                    'poultry': 'Meat', 
                    'beef': 'Meat',
                    'pork': 'Meat',
                    'fish': 'Meat',
                    'seafood': 'Meat',
                    'vegetable': 'Vegetables',
                    'fruit': 'Fruits',
                    'dairy': 'Dairy',
                    'milk': 'Dairy',
                    'cheese': 'Dairy',
                    'yogurt': 'Dairy',
                    'ice-cream': 'Desserts',
                    'dessert': 'Desserts',
                    'frozen-meal': 'Prepared Meals',
                    'pizza': 'Prepared Meals',
                    'ready-meal': 'Prepared Meals'
                };
                
                const lowerCategories = categories.toLowerCase();
                
                for (const [key, value] of Object.entries(categoryMap)) {
                    if (lowerCategories.includes(key)) {
                        return value;
                    }
                }
                
                return 'Other';
            }
            
            getMockProduct(barcode) {
                // Enhanced mock database with real-looking products
                const mockDatabase = {
                    "123456789012": { name: "Organic Ground Turkey", category: "Meat" },
                    "234567890123": { name: "Frozen Mixed Vegetables", category: "Vegetables" },
                    "345678901234": { name: "Premium Ice Cream", category: "Desserts" },
                    "456789012345": { name: "Chicken Breast", category: "Meat" },
                    "567890123456": { name: "Frozen Berries", category: "Fruits" },
                    "678901234567": { name: "Cheese Slices", category: "Dairy" },
                    "789012345678": { name: "Frozen Pizza", category: "Prepared Meals" }
                };
                
                // Return specific product if exists, otherwise generate generic
                return mockDatabase[barcode] || {
                    name: `Product ${barcode.slice(-4)}`,
                    category: 'Other'
                };
            }
            
            showAddModal(isManual = false) {
                if (isManual) {
                    document.getElementById('add-modal-title').textContent = 'Add Item Manually';
                    document.getElementById('add-modal-icon').textContent = 'edit';
                    document.getElementById('barcode-info').classList.add('hidden');
                    this.currentBarcode = null;
                }
                
                document.getElementById('add-modal').classList.remove('hidden');
                document.getElementById('item-name').focus();
            }
            
            hideAddModal() {
                document.getElementById('add-modal').classList.add('hidden');
                document.getElementById('add-item-form').reset();
                document.getElementById('barcode-info').classList.add('hidden');
                document.getElementById('manual-barcode-section').classList.add('hidden');
                document.getElementById('manual-barcode-input').value = '';
                this.currentBarcode = null;
            }
            
            addItem(e) {
                e.preventDefault();
                
                const name = document.getElementById('item-name').value.trim();
                const category = document.getElementById('item-category').value;
                const quantity = parseInt(document.getElementById('item-quantity').value);
                const expirationDate = document.getElementById('item-expiration').value;
                
                if (!name || !expirationDate) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                const item = {
                    id: Date.now(),
                    name,
                    category,
                    quantity,
                    expirationDate,
                    dateAdded: new Date().toISOString().split('T')[0],
                    favorite: false,
                    barcode: this.currentBarcode
                };
                
                this.items.push(item);
                this.saveItems();
                this.renderItems();
                this.updateExpirationAlert();
                this.hideAddModal();
                
                // Show success message
                this.showToast(`Added ${name} to freezer`);
            }
            
            updateQuantity(id, delta) {
                this.items = this.items.map(item => {
                    if (item.id === id) {
                        const newQuantity = Math.max(0, item.quantity + delta);
                        return newQuantity === 0 ? null : { ...item, quantity: newQuantity };
                    }
                    return item;
                }).filter(Boolean);
                
                this.saveItems();
                this.renderItems();
                this.updateExpirationAlert();
            }
            
            toggleFavorite(id) {
                this.items = this.items.map(item => 
                    item.id === id ? { ...item, favorite: !item.favorite } : item
                );
                this.saveItems();
                this.renderItems();
            }
            
            deleteItem(id) {
                if (confirm('Are you sure you want to delete this item?')) {
                    this.items = this.items.filter(item => item.id !== id);
                    this.saveItems();
                    this.renderItems();
                    this.updateExpirationAlert();
                }
            }
            
            getDaysUntilExpiration(expirationDate) {
                const today = new Date();
                const expDate = new Date(expirationDate);
                const diffTime = expDate - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
            
            getExpirationStatus(expirationDate) {
                const days = this.getDaysUntilExpiration(expirationDate);
                if (days < 0) return { status: 'expired', color: 'text-red-600 bg-red-50 border-red-200', text: 'Expired' };
                if (days <= 30) return { status: 'warning', color: 'text-orange-600 bg-orange-50 border-orange-200', text: `${days} days left` };
                return { status: 'good', color: 'text-green-600 bg-green-50 border-green-200', text: `${days} days left` };
            }
            
            getFilteredAndSortedItems() {
                return this.items
                    .filter(item => {
                        const matchesSearch = item.name.toLowerCase().includes(this.searchTerm.toLowerCase());
                        const matchesCategory = this.categoryFilter === 'All' || item.category === this.categoryFilter;
                        return matchesSearch && matchesCategory;
                    })
                    .sort((a, b) => {
                        switch (this.sortBy) {
                            case 'expiration':
                                return new Date(a.expirationDate) - new Date(b.expirationDate);
                            case 'name':
                                return a.name.localeCompare(b.name);
                            case 'quantity':
                                return b.quantity - a.quantity;
                            case 'dateAdded':
                                return new Date(b.dateAdded) - new Date(a.dateAdded);
                            default:
                                return 0;
                        }
                    });
            }
            
            renderItems() {
                const container = document.getElementById('items-container');
                const emptyState = document.getElementById('empty-state');
                const items = this.getFilteredAndSortedItems();
                
                if (items.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                container.innerHTML = items.map(item => {
                    const expStatus = this.getExpirationStatus(item.expirationDate);
                    return `
                        <div class="bg-white rounded-lg elevation-1 p-4 hover:elevation-2 transition-all animate-fade-in">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <h3 class="font-medium text-gray-900 text-lg">${item.name}</h3>
                                        <button onclick="app.toggleFavorite(${item.id})" class="${item.favorite ? 'text-amber-500' : 'text-gray-300'} hover:text-amber-500 transition-colors">
                                            <span class="material-icons text-xl">${item.favorite ? 'star' : 'star_border'}</span>
                                        </button>
                                    </div>
                                    <p class="text-sm font-medium text-indigo-600 mb-1">${item.category}</p>
                                    <div class="flex items-center space-x-4 text-xs text-gray-500">
                                        <div class="flex items-center space-x-1">
                                            <span class="material-icons text-xs">schedule</span>
                                            <span>Added ${item.dateAdded}</span>
                                        </div>
                                        ${item.barcode ? `
                                            <div class="flex items-center space-x-1">
                                                <span class="material-icons text-xs">qr_code</span>
                                                <span>Scanned</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <button onclick="app.deleteItem(${item.id})" class="text-gray-400 hover:text-red-500 transition-colors p-1">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <button onclick="app.updateQuantity(${item.id}, -1)" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                                        <span class="material-icons text-gray-600">remove</span>
                                    </button>
                                    
                                    <div class="flex items-center space-x-2">
                                        <span class="material-icons text-gray-500">inventory_2</span>
                                        <span class="font-semibold text-xl text-gray-900">${item.quantity}</span>
                                    </div>
                                    
                                    <button onclick="app.updateQuantity(${item.id}, 1)" class="w-10 h-10 bg-indigo-100 hover:bg-indigo-200 rounded-full flex items-center justify-center transition-colors">
                                        <span class="material-icons text-indigo-600">add</span>
                                    </button>
                                </div>
                                
                                <div class="px-3 py-1 rounded-full text-sm font-medium border ${expStatus.color}">
                                    ${expStatus.text}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            updateExpirationAlert() {
                const expiringItems = this.items.filter(item => this.getDaysUntilExpiration(item.expirationDate) <= 30);
                const alert = document.getElementById('expiration-alert');
                const text = document.getElementById('expiration-text');
                
                if (expiringItems.length > 0) {
                    text.textContent = `${expiringItems.length} item${expiringItems.length > 1 ? 's' : ''} expiring soon`;
                    alert.classList.remove('hidden');
                    
                    // Send notification if permission granted
                    if (Notification.permission === 'granted') {
                        new Notification('FRZR: Items Expiring Soon', {
                            body: `${expiringItems.length} item${expiringItems.length > 1 ? 's' : ''} in your freezer will expire within 30 days.`,
                            icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>❄️</text></svg>",
                            tag: 'expiring-items'
                        });
                    }
                } else {
                    alert.classList.add('hidden');
                }
            }
            
            showStatsModal() {
                const categories = ['Meat', 'Vegetables', 'Fruits', 'Dairy', 'Prepared Meals', 'Desserts', 'Other'];
                const categoryStats = categories.map(cat => ({
                    category: cat,
                    count: this.items.filter(item => item.category === cat).length,
                    totalQuantity: this.items.filter(item => item.category === cat).reduce((sum, item) => sum + item.quantity, 0)
                })).filter(stat => stat.count > 0);
                
                const expiringItems = this.items.filter(item => this.getDaysUntilExpiration(item.expirationDate) <= 30);
                
                // Update stats
                document.getElementById('total-items').textContent = this.items.length;
                document.getElementById('total-quantity').textContent = this.items.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById('expiring-count').textContent = expiringItems.length;
                
                // Update category stats
                const categoryStatsContainer = document.getElementById('category-stats');
                categoryStatsContainer.innerHTML = categoryStats.map(stat => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">${stat.category}</span>
                        <div class="text-right">
                            <div class="text-sm font-semibold text-gray-900">${stat.count} items</div>
                            <div class="text-xs text-gray-500">${stat.totalQuantity} total</div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('stats-modal').classList.remove('hidden');
            }
            
            hideStatsModal() {
                document.getElementById('stats-modal').classList.add('hidden');
            }
            
            showToast(message) {
                // Create toast notification
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg z-50 animate-fade-in';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
            
            saveItems() {
                localStorage.setItem('frzr-items', JSON.stringify(this.items));
            }
        }
        
        // Initialize app
        const app = new FRZRApp();
        
        // Override manual add to show manual modal
        document.getElementById('manual-add-btn').addEventListener('click', () => {
            app.showAddModal(true);
        });
        
        // Service Worker for PWA functionality
        const swCode = `
            const CACHE_NAME = 'frzr-v1';
            const urlsToCache = [
                '/',
                '/manifest.json'
            ];
            
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then((cache) => cache.addAll(urlsToCache))
                );
            });
            
            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request)
                        .then((response) => {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        })
                );
            });
        `;
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'k':
                        e.preventDefault();
                        document.getElementById('search-input').focus();
                        break;
                    case 'n':
                        e.preventDefault();
                        app.showAddModal(true);
                        break;
                    case 's':
                        e.preventDefault();
                        app.startScanning();
                        break;
                }
            }
        });
        
        // Add some sample data for demo
        if (app.items.length === 2) {
            // Add more sample items for better demo
            const sampleItems = [
                {
                    id: 3,
                    name: "Frozen Pizza",
                    quantity: 3,
                    dateAdded: "2025-08-20",
                    expirationDate: "2025-09-20",
                    category: "Prepared Meals",
                    favorite: false,
                    barcode: "345678901234"
                },
                {
                    id: 4,
                    name: "Ice Cream Sandwiches",
                    quantity: 1,
                    dateAdded: "2025-08-18",
                    expirationDate: "2026-01-18",
                    category: "Desserts",
                    favorite: true,
                    barcode: null
                }
            ];
            
            app.items.push(...sampleItems);
            app.saveItems();
            app.renderItems();
            app.updateExpirationAlert();
        }
    </script>
</body>
</html>
